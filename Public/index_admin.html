<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Administration - Page de l'ennui</title>

        <link rel="preload"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
            as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript>
            <link rel="stylesheet"
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
        </noscript>

        <link rel="stylesheet" type="text/css" href="css/common.css" />
        <link rel="stylesheet" type="text/css" href="css/stage3.css" />
        <link rel="stylesheet" type="text/css" href="css/admin.css" />

        <link rel="icon" type="img/png" href="imgs/icon_d.png"
            media="(prefers-color-scheme: dark)" />
        <link rel="icon" type="img/png" href="imgs/icon_l.png"
            media="(prefers-color-scheme: light)" />
    </head>
    <body>
        <div class="admin-container">
            <div class="admin-header">

                <h1><i class="fa-solid fa-wrench"></i> PANEL
                    ADMIN</h1><div class="header-btns">
                    <button class="log-off"
                        onclick="window.location.replace('/login');">Se
                        déconnecter</button>
                    <button class="log-off"
                        onclick="window.open('/admin/logs', '_blank');">Logs</button>
                </div>
            </div>

            <div class="admin-sections">
                <!-- LEADERBOARDS -->
                <section class="admin-section">
                    <h2><i class="fa-solid fa-trophy"></i> /Leaderboards</h2>
                    <center>
                        <div class="leaderboard-tabs">
                            <button class="lb-tab active"
                                data-board="clicker">Clicker</button>
                            <button class="lb-tab"
                                data-board="dino">Dino</button>
                            <button class="lb-tab" data-board="flappy">Flappy
                            </button>
                            <button class="lb-tab" data-board="uno">UNO</button>
                            <button class="lb-tab"
                                data-board="pictionary">Pictionary</button>
                            <button class="lb-tab" data-board="p4">P4</button>
                            <button class="lb-tab" data-board="blockblast">Block
                                Blast</button>
                            <button class="lb-tab"
                                data-board="snake">Snake</button>
                        </div>
                    </center>

                    <div class="leaderboard-content active"
                        data-board="clicker">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Clicks</th>
                                </tr>
                            </thead>
                            <tbody id="lb-clicker"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="dino">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="lb-dino"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="flappy">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="lb-flappy"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="uno">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Victoires</th>
                                </tr>
                            </thead>
                            <tbody id="lb-uno"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="pictionary">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody id="lb-pictionary"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="p4">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Victoires</th>
                                </tr>
                            </thead>
                            <tbody id="lb-p4"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="blockblast">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Score</th>
                                    <th>Temps</th>
                                </tr>
                            </thead>
                            <tbody id="lb-blockblast"></tbody>
                        </table>
                    </div>

                    <div class="leaderboard-content" data-board="snake">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Pseudo</th>
                                    <th>Score</th>
                                    <th>Temps</th>
                                </tr>
                            </thead>
                            <tbody id="lb-snake"></tbody>
                        </table>
                    </div>
                </section>

                <!-- CHAT LAN -->
                <section class="admin-section" id="chat">
                    <h2><i class="fa-solid fa-comments"
                            style="margin-right:10px"></i>/Chat LAN</h2>
                    <div class="chat-card" role="region" aria-label="Chat LAN">
                        <div class="chat-header">
                            <h3>Chat.exe</h3>
                            <div class="chat-status">
                                <span id="me"></span>
                                <span id="usersCount"></span>
                            </div>
                        </div>
                        <div id="chat-messages" class="chat-messages"
                            aria-live="polite"></div>
                        <form id="chat-form" autocomplete="off"
                            autocorrect="off" class="chat-form">
                            <textarea id="chat-input" rows="1"
                                placeholder="Écris ton message..."></textarea>
                            <button type="submit" title="Envoyer message"
                                class="submit"><i
                                    class="fa-solid fa-circle-arrow-right"></i></button>
                        </form>
                    </div>
                </section>

                <!-- USER INFO -->
                <section class="admin-section">
                    <h2><i class="fa-solid fa-user"
                            style="margin-right: 10px;"></i>/Infos
                        Utilisateur</h2>

                    <div class="user-search">
                        <input type="text" id="userSearchInput"
                            placeholder="Rechercher un utilisateur par pseudo (sensible à la casse)..." />
                        <div
                            style="font-size:12px;color:#9a9a9a;margin-top:6px;">Case
                            Sensitive</div>
                    </div>

                    <div class="user-info-display" id="userInfoDisplay">
                        <h3 id="userInfoPseudo"
                            style="margin-bottom: 15px;"></h3>
                        <div id="userInfoStats"></div>
                    </div>
                </section>

                <!-- ADMINISTRATION -->
                <section class="admin-section">
                    <h2><i class="fa-solid fa-gear"></i> /Commandes</h2>

                    <div class="admin-controls">
                        <!-- Modifier Stats -->
                        <div class="control-group">
                            <h3><i class="fa-solid fa-chart-simple"></i>
                                /Modifier Stats</h3>
                            <div class="control-form">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Pseudo</label>
                                        <input type="text" id="modifyUser"
                                            placeholder="Pseudo (ou ALL pour cibler tout le monde)" />
                                    </div>
                                    <div class="form-field">
                                        <label>Stat ?</label>
                                        <select id="modifyStatType">
                                            <option
                                                value="clicks">Clicker</option>
                                            <option
                                                value="dinoScores">Dino</option>
                                            <option
                                                value="flappyScores">Flappy</option>
                                            <option value="unoWins">UNO</option>
                                            <option
                                                value="pictionaryWins">Pictionary</option>
                                            <option value="p4Wins">P4</option>
                                            <option
                                                value="blockblastScores">Block
                                                Blast</option>
                                            <option
                                                value="snakeScores">Snake</option>
                                            <option value="all">Toutes les
                                                stats</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Nouvelle Valeur</label>
                                        <input type="number"
                                            id="modifyStatValue"
                                            placeholder="Nouvelle valeur" />
                                    </div>
                                    <div class="form-field">
                                        <label>Nouvelle durée (ms)</label>
                                        <input type="number" id="modifyStatTime"
                                            placeholder="Durée en ms" />
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn"
                                            onclick="modifyStat()">
                                            <i class="fa-solid fa-pen"></i>
                                            Modifier
                                        </button>
                                        <button class="btn" onclick="addStat()">
                                            <i class="fa-solid fa-plus"></i>
                                            Ajouter
                                        </button>
                                        <button class="btn btn-red"
                                            onclick="removeStat()">
                                            <i class="fa-solid fa-minus"></i>
                                            Retirer
                                        </button>
                                        <button class="btn"
                                            onclick="modifyTime()"
                                            title="Modifier le meilleur temps">
                                            <i class="fa-solid fa-clock"></i>
                                            Modifier Temps
                                        </button>
                                        <button class="btn btn-red"
                                            onclick="removeTime()"
                                            title="Supprimer le meilleur temps">
                                            <i
                                                class="fa-solid fa-trash-can"></i>
                                            Supprimer Temps
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gestion des Tags -->
                        <div class="control-group">
                            <h3><i class="fa-solid fa-tag"></i> /Tags</h3>
                            <div class="control-form">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Pseudo</label>
                                        <input type="text" id="tagUser"
                                            placeholder="Pseudo" />
                                    </div>
                                    <div class="form-field">
                                        <label>Tag</label>
                                        <div style="display:flex; gap:5px;">
                                            <input type="text" id="tagValue"
                                                placeholder="Tag..."
                                                style="flex:1" />
                                            <input type="color" id="tagColor"
                                                value="#ff0000"
                                                style="width:50px;padding:0;border:none;height:38px;cursor:pointer;"
                                                title="Couleur du tag" />
                                        </div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" onclick="setTag()">
                                            <i class="fa-solid fa-check"></i>
                                            Définir
                                        </button>
                                        <button class="btn btn-red"
                                            onclick="removeTag()">
                                            <i class="fa-solid fa-trash"></i>
                                            Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Supprimer Utilisateur -->
                        <div class="control-group">
                            <h3><i class="fa-solid fa-trash"></i> /Supprimer
                                Utilisateur</h3>
                            <div class="control-form">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Pseudo</label>
                                        <input type="text" id="deleteUser"
                                            placeholder="Pseudo à supprimer" />
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn btn-red"
                                            onclick="deleteUser()">
                                            <i class="fa-solid fa-trash"></i>
                                            Supprimer
                                        </button>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Leaderboard ?</label>
                                        <select id="clearLbType">
                                            <option value="all">Tous</option>
                                            <option
                                                value="clicker">Clicker</option>
                                            <option value="dino">Dino</option>
                                            <option
                                                value="flappy">Flappy</option>
                                            <option value="uno">UNO</option>
                                            <option
                                                value="pictionary">Pictionary</option>
                                            <option value="p4">P4</option>
                                            <option value="blockblast">Block
                                                Blast</option>
                                            <option value="snake">Snake</option>
                                        </select>
                                    </div>

                                    <div class="action-buttons">
                                        <button class="btn btn-red"
                                            onclick="clearFromLeaderboard()">
                                            <i class="fa-solid fa-eraser"></i>
                                            Supprimer des Leaderboards
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notification Globale -->
                        <div class="control-group">
                            <h3><i class="fa-solid fa-bullhorn"></i>
                                /Notif</h3>
                            <div class="control-form">
                                <div class="form-field">
                                    <label>Message</label>
                                    <textarea id="notificationMessage"
                                        placeholder="Message à envoyer à tlm"></textarea>
                                </div>
                                <div class="form-field">
                                    <label id="cntdwnlbl">
                                        <input type="checkbox"
                                            id="countdownCheckbox">
                                        <span>Countdown ?</span>
                                    </label>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn"
                                        onclick="sendGlobalNotification()">
                                        <i class="fa-solid fa-bell"></i> Envoyer
                                        à Tous
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- BLACKLIST -->
                <section class="admin-section">
                    <h2><i class="fa-solid fa-ban"></i> /Blacklist</h2>
                    <div class="control-form">
                        <div style="margin-bottom:8px">IP(s) blacklistées:
                            <strong id="blacklistCount">0</strong></div>

                        <div class="form-row">
                            <div class="form-field">
                                <label>IP à bannir</label>
                                <input type="text" id="blacklistInput"
                                    placeholder="127.0.0.1" />
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-red"
                                    onclick="addBanFromInput()">Bannir</button>
                                <!--<button class="btn"
                                    onclick="loadBlacklist()">Rafraîchir</button>-->
                            </div>
                        </div>

                        <!-- textarea removed: blacklist managed via add/remove buttons -->

                        <div style="margin-top:12px">
                            <label>Liste actuelle</label>
                            <table
                                style="width:100%;border-collapse:collapse;margin-top:6px"><tbody
                                    id="blacklistList"></tbody></table>
                        </div>
                    </div>
                </section>

                <!-- LOGS -->
                <section class="admin-section">
                    <h2><i class="fa-solid fa-database"></i> /Logs</h2>
                    <center>
                        <iframe src="logs.html"
                            class="logs-frame"></iframe>
                    </center>
                </section>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript">
        let socket;
        let currentUser = null;
        let chatModule = null;

        async function checkSes() {
            const res = await fetch('/api/session');
            if (!res.ok) {
                window.location.href = '/login';
                return;
            }
            const data = await res.json();
            currentUser = data.pseudo;
            
            if (currentUser !== 'Admin' && currentUser !== 'RayanAdmin') {
                window.location.href = '/';
                return;
            }

            try {
                chatModule = await import('/js/chat.js');
            } catch (err) {
                console.warn('Impossible de précharger le module de chat:', err);
                chatModule = null;
            }

            initSocket();
        }

        // Initialiser Socket.IO
        function initSocket() {
            // on crée la socket sans auto-connexion pour pouvoir initialiser
            // les handlers du module chat avant que le serveur n'émette des événements
            socket = io({
                query: { username: currentUser },
                autoConnect: false,
            });

            // initialiser le module chat (s'il a été préchargé)
            try {
                if (chatModule && typeof chatModule.initChat === 'function') {
                    chatModule.initChat(socket);
                }
            } catch (err) {
                console.warn('Erreur lors de l\'initialisation du module chat:', err);
            }

            // connecte après l'initialisation des handlers
            socket.connect();

            socket.on('connect', () => {
                console.log('> Connecté au serveur');
            });

            // Auto-reload sur modification de fichiers
            socket.on('reload', (data) => {
                const file = data?.file || '';
                // Recharger seulement les CSS sans reset de socket
                if (file.match(/\.css$/i)) {
                    document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                        const href = link.href.split('?')[0];
                        link.href = href + '?v=' + Date.now();
                    });
                } else if (file.match(/\.js$/i) || file.match(/\.html$/i)) {
                    // Pour les JS/HTML, reload complet nécessaire
                    window.location.reload();
                }
            });

            // Leaderboards
            socket.on('clicker:leaderboard', (data) => updateLeaderboard('clicker', data, 'score'));
            socket.on('dino:leaderboard', (data) => updateLeaderboard('dino', data, 'score'));
            socket.on('flappy:leaderboard', (data) => updateLeaderboard('flappy', data, 'score'));
            socket.on('uno:leaderboard', (data) => updateLeaderboard('uno', data, 'wins'));
            socket.on('pictionary:leaderboard', (data) => updateLeaderboard('pictionary', data, 'points'));
            socket.on('p4:leaderboard', (data) => updateLeaderboard('p4', data, 'wins'));
            socket.on('blockblast:leaderboard', (data) => updateLeaderboard('blockblast', data, 'score'));
            socket.on('snake:leaderboard', (data) => updateLeaderboard('snake', data, 'score'));

            // Notifications globales (admin voit aussi le countdown)
            socket.on('system:notification', (data) => {
                adminShowNotif(
                    data && data.message ? data.message : 'Notification',
                    (data && data.duration) ? data.duration : 8000,
                    !!(data && data.withCountdown)
                );
            });

            socket.on('system:redirect', (url) => {
                window.location.href = url;
            });

            // Blacklist admin socket handlers
            socket.on('admin:blacklist:result', (res) => {
                if (!res) return;
                if (!res.success) return showNotification(`❌ ${res.message || 'Erreur blacklist'}`, 'error');
                window.__adminBlacklistData = res.data || { alwaysBlocked: [] };
                window.__adminBlacklistForced = Array.isArray(res.forced) ? res.forced : [];
                renderBlacklist();
            });

            socket.on('admin:blacklist:updated', (alwaysBlocked) => {
                window.__adminBlacklistData = { alwaysBlocked: Array.isArray(alwaysBlocked) ? alwaysBlocked : [] };
                if (!Array.isArray(window.__adminBlacklistForced)) window.__adminBlacklistForced = [];
                renderBlacklist();
                showNotification('✅ Blacklist mise à jour', 'success');
            });
        }

        function updateLeaderboard(type, data, valueKey) {
            const tbody = document.getElementById(`lb-${type}`);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                let val = item[valueKey];
                if (typeof val === 'number') {
                    val = val.toLocaleString('fr-FR');
                }

                let extraTd = '';
                // Gestion spécifique pour afficher le temps si présent (BlockBlast / Snake)
                if ((type === 'blockblast' || type === 'snake')) {
                     const t = item.timeMs;
                     let timeTxt = '—';
                     if (typeof t === 'number') {
                        const totalSec = Math.floor(t / 1000);
                        const h = Math.floor(totalSec / 3600);
                        const m = Math.floor((totalSec % 3600) / 60);
                        const s = totalSec % 60;
                        if (h > 0) {
                            timeTxt = `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        } else {
                            timeTxt = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        }
                     }
                     extraTd = `<td>${timeTxt}</td>`;
                }

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.pseudo}</td>
                    <td>${val}</td>
                    ${extraTd}
                `;
                tbody.appendChild(tr);
            });
        }

        // Tabs Leaderboard
        document.querySelectorAll('.lb-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const board = tab.dataset.board;
                
                document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.leaderboard-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.querySelector(`.leaderboard-content[data-board="${board}"]`).classList.add('active');
            });
        });

        // Recherche utilisateur
        document.getElementById('userSearchInput').addEventListener('input', async (e) => {
            const pseudo = e.target.value.trim();
            if (!pseudo) {
                document.getElementById('userInfoDisplay').classList.remove('visible');
                return;
            }

            try {
                const res = await fetch(`/api/admin/user-info?pseudo=${encodeURIComponent(pseudo)}`);
                if (!res.ok) {
                    showNotification('❌ Utilisateur non trouvé', 'error');
                    document.getElementById('userInfoDisplay').classList.remove('visible');
                    return;
                }
                
                const data = await res.json();
                displayUserInfo(data);
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la recherche', 'error');
            }
        });

        function displayUserInfo(data) {
            const display = document.getElementById('userInfoDisplay');
            const pseudoEl = document.getElementById('userInfoPseudo');
            const statsEl = document.getElementById('userInfoStats');
            
            pseudoEl.innerHTML = `<i class="fa-solid fa-user"></i> ${data.pseudo}`;
            const metaHtml = `
                <div class="user-meta">
                    <div class="user-stat">
                        <span class="label">ID:</span>
                        <span class="value">${data.id || '—'}</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Créé le:</span>
                        <span class="value">${data.createdAt ? new Date(data.createdAt).toLocaleString() : '—'}</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Créé par (IP):</span>
                        <span class="value">${data.createdFromIp || '—'}</span>
                    </div>
                </div>
            `;

            statsEl.innerHTML = `
                <div class="user-stat">
                    <span class="label">Clicks (Clicker):</span>
                    <span class="value">${data.clicks || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score Dino:</span>
                    <span class="value">${data.dinoScore || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score Flappy:</span>
                    <span class="value">${data.flappyScore || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Victoires UNO:</span>
                    <span class="value">${data.unoWins || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Points Pictionary:</span>
                    <span class="value">${data.pictionaryPoints || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Victoires P4:</span>
                    <span class="value">${data.p4Wins || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score Block Blast:</span>
                    <span class="value">${data.blockblastScore || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Médailles:</span>
                    <span class="value">${data.medals ? data.medals.length : 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Tag:</span>
                    <span class="value">${
                        typeof data.tag === 'object' && data.tag !== null
                            ? `<span style="color:${data.tag.color || 'inherit'}">${data.tag.text}</span>`
                            : (data.tag || '—')
                    }</span>
                </div>
            `;

            pwdLength = data.password ? data.password.length : 0;
            hashedPwdLength = data.password ? data.passwordHash.length : 0;

            const pwdHtml = `
                <div class="user-passwords">
                    <div class="user-stat">
                        <span class="label">MPD :</span>
                        <span class="value" id="pwdPlain">${data.password ? "•".repeat(pwdLength) : '—'}</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">MDP HASH :</span>
                        <span class="value" id="pwdHash">${data.passwordHash ? '•'.repeat(hashedPwdLength) : '—'}</span>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn" id="togglePwdBtn">Afficher les mdp</button>
                    </div>
                </div>
            `;

            // Préfixer par les meta si disponibles
            statsEl.innerHTML = metaHtml + pwdHtml + statsEl.innerHTML;

            display.classList.add('visible');

            // Attacher le comportement du bouton pour afficher/masquer les mdp
            const toggleBtn = document.getElementById('togglePwdBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const plainEl = document.getElementById('pwdPlain');
                    const hashEl = document.getElementById('pwdHash');
                    if (!plainEl || !hashEl) return;

                    const visible = plainEl.dataset.visible === '1';
                    if (visible) {
                        plainEl.textContent = data.password ? '••••••' : '—';
                        hashEl.textContent = data.passwordHash ? '••••••' : '—';
                        plainEl.dataset.visible = '0';
                        toggleBtn.textContent = 'Afficher les mdp';
                    } else {
                        plainEl.textContent = data.password || '—';
                        hashEl.textContent = data.passwordHash || '—';
                        plainEl.dataset.visible = '1';
                        toggleBtn.textContent = 'Masquer les mdp';
                    }
                });
                // initialiser état masqué
                const plainElInit = document.getElementById('pwdPlain');
                if (plainElInit) plainElInit.dataset.visible = '0';
            }
        }

        // Modifier Stat
        async function modifyStat() {
  const pseudo = document.getElementById('modifyUser').value.trim();
  const statType = document.getElementById('modifyStatType').value;
  const value = parseInt(document.getElementById('modifyStatValue').value);

  if (!pseudo || isNaN(value)) {
    showNotification('⚠️ Veuillez remplir tous les champs', 'error');
    return;
  }

  const targetAll = pseudo.toUpperCase() === 'ALL';
  const confirmMsg = targetAll 
    ? `Modifier ${statType} de ALL LES JOUEURS à ${value} ?`
    : `Modifier ${statType} de ${pseudo} à ${value} ?`;
  
  if (!confirm(confirmMsg)) return;

  if (statType === 'all') {
    if (!confirm(`⚠️ Vous êtes sur le point de modifier TOUTES les stats ${targetAll ? 'de ALL LES JOUEURS' : 'de ' + pseudo} à ${value} ! Confirmer ?`)) return;
  }

  try {
    const endpoint = targetAll ? '/api/admin/modify-all-users-stat' : '/api/admin/modify-stat';
    const body = targetAll 
      ? { statType, value }
      : { pseudo, statType, value };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    
    if (res.ok) {
      showNotification(`✅ ${data.message}`, 'success');
      socket.emit('admin:refresh');
      document.getElementById('modifyUser').value = '';
      document.getElementById('modifyStatValue').value = '';
    } else {
      showNotification(`❌ ${data.message}`, 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('⚠️ Erreur lors de la modification', 'error');
  }
}

async function addStat() {
  const pseudo = document.getElementById('modifyUser').value.trim();
  const statType = document.getElementById('modifyStatType').value;
  const value = parseInt(document.getElementById('modifyStatValue').value);

  if (!pseudo || isNaN(value)) {
    showNotification('⚠️ Veuillez remplir tous les champs avec une valeur positive', 'error');
    return;
  }

  const targetAll = pseudo.toUpperCase() === 'ALL';
  const confirmMsg = targetAll 
    ? `Ajouter ${value} à ${statType} de ALL LES JOUEURS ?`
    : `Ajouter ${value} à ${statType} de ${pseudo} ?`;
  
  if (!confirm(confirmMsg)) return;

  try {
    const endpoint = targetAll ? '/api/admin/add-all-users-stat' : '/api/admin/add-stat';
    const body = targetAll 
      ? { statType, value }
      : { pseudo, statType, value };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    
    if (res.ok) {
      showNotification(`✅ ${data.message}`, 'success');
      socket.emit('admin:refresh');
      document.getElementById('modifyUser').value = '';
      document.getElementById('modifyStatValue').value = '';
    } else {
      showNotification(`❌ ${data.message}`, 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('⚠️ Erreur lors de l\'ajout', 'error');
  }
}

async function removeStat() {
  const pseudo = document.getElementById('modifyUser').value.trim();
  const statType = document.getElementById('modifyStatType').value;
  const value = parseInt(document.getElementById('modifyStatValue').value);

  if (!pseudo || isNaN(value) || value <= 0) {
    showNotification('⚠️ Veuillez remplir tous les champs avec une valeur positive', 'error');
    return;
  }

  const targetAll = pseudo.toUpperCase() === 'ALL';
  const confirmMsg = targetAll 
    ? `Retirer ${value} de ${statType} de ALL LES JOUEURS ?`
    : `Retirer ${value} de ${statType} de ${pseudo} ?`;
  
  if (!confirm(confirmMsg)) return;

  try {
        const endpoint = targetAll ? '/api/admin/remove-all-users-stat' : '/api/admin/remove-stat';
        const body = targetAll 
            ? { statType, value }
            : { pseudo, statType, value };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    
    if (res.ok) {
      showNotification(`✅ ${data.message}`, 'success');
      socket.emit('admin:refresh');
      document.getElementById('modifyUser').value = '';
      document.getElementById('modifyStatValue').value = '';
    } else {
      showNotification(`❌ ${data.message}`, 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('⚠️ Erreur lors de la suppression', 'error');
  }
}

// Modifier / Supprimer les best-times (snake, blockblast)
async function modifyTime() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const board = document.getElementById('modifyStatType').value;
    const time = parseInt(document.getElementById('modifyStatTime').value);

    if (!pseudo || isNaN(time) || time < 0) {
        showNotification('⚠️ Veuillez entrer un pseudo et une durée valide (ms)', 'error');
        return;
    }

    // Accept only snakeScores or blockblastScores as boards for time editing
    const allowed = { snakeScores: 'snake', blockblastScores: 'blockblast' };
    if (!allowed[board]) {
        showNotification('⚠️ Sélectionnez Snake ou Block Blast dans Stat ?', 'error');
        return;
    }

    if (!confirm(`Définir la durée (${time} ms) pour ${pseudo} sur ${allowed[board]} ?`)) return;

    try {
        const res = await fetch('/api/admin/modify-time', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pseudo, boardType: allowed[board], time })
        });
        const data = await res.json();
        if (res.ok) {
            showNotification(`✅ ${data.message}`, 'success');
            if (socket) socket.emit('admin:refresh');
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
    } catch (e) {
        console.error(e);
        showNotification('⚠️ Erreur lors de la modification du temps', 'error');
    }
}

async function removeTime() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const board = document.getElementById('modifyStatType').value;

    if (!pseudo) {
        showNotification('⚠️ Veuillez entrer un pseudo', 'error');
        return;
    }

    const allowed = { snakeScores: 'snake', blockblastScores: 'blockblast' };
    if (!allowed[board]) {
        showNotification('⚠️ Sélectionnez Snake ou Block Blast dans Stat ?', 'error');
        return;
    }

    if (!confirm(`Supprimer la durée enregistrée pour ${pseudo} sur ${allowed[board]} ?`)) return;

    try {
        const res = await fetch('/api/admin/remove-time', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pseudo, boardType: allowed[board] })
        });
        const data = await res.json();
        if (res.ok) {
            showNotification(`✅ ${data.message}`, 'success');
            if (socket) socket.emit('admin:refresh');
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
    } catch (e) {
        console.error(e);
        showNotification('⚠️ Erreur lors de la suppression du temps', 'error');
    }
}

        // Gestion des Tags
        async function setTag() {
            const pseudo = document.getElementById('tagUser').value.trim();
            const tag = document.getElementById('tagValue').value.trim();
            const color = document.getElementById('tagColor').value;

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/set-tag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo, tag, color })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    document.getElementById('tagUser').value = '';
                    document.getElementById('tagValue').value = '';
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la définition du tag', 'error');
            }
        }

        async function removeTag() {
            const pseudo = document.getElementById('tagUser').value.trim();

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            if (!confirm(`Supprimer le tag de ${pseudo} ?`)) return;

            try {
                const res = await fetch('/api/admin/remove-tag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    document.getElementById('tagUser').value = '';
                    document.getElementById('tagValue').value = '';
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la suppression du tag', 'error');
            }
        }

        // Supprimer Utilisateur
        async function deleteUser() {
            const pseudo = document.getElementById('deleteUser').value.trim();

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            if (pseudo === 'Admin' || pseudo === 'RayanAdmin') {
                showNotification('❌ Impossible de supprimer cet administrateur', 'error');
                return;
            }

            if (!confirm(`⚠️ ATTENTION ⚠️\n\nSupprimer définitivement l'utilisateur "${pseudo}" ?\n\nToutes ses données seront perdues !`)) return;

            try {
                const res = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    document.getElementById('deleteUser').value = '';
                    socket.emit('admin:refresh');
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la suppression', 'error');
            }
        }

        // Supprimer des Leaderboards (sans supprimer l'utilisateur)
        async function clearFromLeaderboard() {
            const pseudo = document.getElementById('deleteUser').value.trim();
            const boardType = document.getElementById('clearLbType').value;
            const resetTimes = !!document.getElementById('clearResetTimes') && document.getElementById('clearResetTimes').checked;

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            const labelMap = {
                all: 'tous les leaderboards',
                clicker: 'Clicker',
                dino: 'Dino',
                flappy: 'Flappy',
                uno: 'UNO',
                pictionary: 'Pictionary',
                p4: 'P4',
                blockblast: 'Block Blast',
                snake: 'Snake',
            };

            const label = labelMap[boardType] || boardType;
            if (!confirm(`Supprimer les entrées ${label} de "${pseudo}" ?`)) return;

            try {
                const res = await fetch('/api/admin/clear-from-leaderboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo, boardType, resetTimes })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    if (socket) socket.emit('admin:refresh');
                } else {
                    showNotification(`❌ ${data.message || 'Erreur lors du nettoyage'}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors du nettoyage des leaderboards', 'error');
            }
        }

        // Blacklist admin helpers
        function loadBlacklist() {
            if (!socket) return;
            socket.emit('admin:blacklist:get');
        }

        socket && socket.on && socket.on('admin:blacklist:result', (res) => {
            if (!res) return;
            if (!res.success) return showNotification(`❌ ${res.message || 'Erreur blacklist'}`, 'error');
            window.__adminBlacklistData = res.data || { alwaysBlocked: [] };
            window.__adminBlacklistForced = Array.isArray(res.forced) ? res.forced : [];
            renderBlacklist();
        });

        socket && socket.on && socket.on('admin:blacklist:updated', (alwaysBlocked) => {
            // admin:blacklist:updated provides updated alwaysBlocked array; forced list remains from initial payload
            window.__adminBlacklistData = { alwaysBlocked: Array.isArray(alwaysBlocked) ? alwaysBlocked : [] };
            // ensure forced list exists
            if (!Array.isArray(window.__adminBlacklistForced)) window.__adminBlacklistForced = [];
            renderBlacklist();
            showNotification('✅ Blacklist mise à jour', 'success');
        });

        function renderBlacklist() {
            const data = window.__adminBlacklistData || { alwaysBlocked: [] };
            const arr = Array.isArray(data.alwaysBlocked) ? data.alwaysBlocked : [];
            const list = document.getElementById('blacklistList');
            const count = document.getElementById('blacklistCount');
            if (count) count.textContent = arr.length;
            if (!list) return;
            list.innerHTML = '';
            const forced = Array.isArray(window.__adminBlacklistForced) ? window.__adminBlacklistForced : [];
            arr.forEach(ip => {
                const tr = document.createElement('tr');
                const isForced = forced.includes(ip);
                if (isForced) {
                    tr.innerHTML = `<td style="padding:6px;border:1px solid #222">${ip} <span style="color:#b00;font-weight:700;margin-left:8px">(FORCÉE)</span></td><td style="padding:6px;border:1px solid #222;text-align:right"><button class="btn" disabled style="opacity:0.5;cursor:not-allowed">Unban</button></td>`;
                } else {
                    tr.innerHTML = `<td style="padding:6px;border:1px solid #222">${ip}</td><td style="padding:6px;border:1px solid #222;text-align:right"><button class="btn btn-red" onclick="removeBan('${ip}')">Unban</button></td>`;
                }
                list.appendChild(tr);
            });
        }

        function addBanFromInput() {
            const ip = document.getElementById('blacklistInput').value.trim();
            var ipv4Regex = /^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipv4Regex.test(ip)) return showNotification('⚠️ Entrez une IP IPv4 valide', 'error');
            if (!ip) return showNotification('⚠️ Entrez une IP', 'error');
            if (!confirm(`Bannir ${ip} ?`)) return;
            socket.emit('admin:blacklist:add', { ip });
            loadBlacklist();
            document.getElementById('blacklistInput').value = '';
        }

        function removeBan(ip) {
            if (!confirm(`Retirer le ban pour ${ip} ?`)) return;
            socket.emit('admin:blacklist:remove', { ip });
        }

        // load initial list when admin page connects
        (function waitForSocketThenLoad() {
            const attempt = () => {
                if (socket && socket.connected) {
                    loadBlacklist();
                } else {
                    setTimeout(attempt, 250);
                }
            };
            attempt();
        })();

        // Notification Globale
        function sendGlobalNotification() {
            const message = document.getElementById('notificationMessage').value.trim();
            const withCountdown = document.getElementById('countdownCheckbox').checked;

            if (!message) {
                showNotification('⚠️ Veuillez entrer un message', 'error');
                return;
            }

            const countdownText = withCountdown ? '\n\n(countdown ?)' : '';
            if (!confirm(`Envoyer cette notification à tous les utilisateurs ?${countdownText}\n\n"${message}"`)) return;

            socket.emit('admin:global-notification', { message, withCountdown });
            showNotification(`✅ Notification envoyée à tous${withCountdown ? ' (avec countdown)' : ''}`, 'success');
            document.getElementById('notificationMessage').value = '';
            document.getElementById('countdownCheckbox').checked = false;
        }

        function adminShowNotif(text, duration = 4000, withCountdown = false) {
            try {
                const notif = document.createElement('div');
                notif.className = 'notif';
                notif.textContent = text;
                notif.style.cssText = `
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  background: #0f0;
                  opacity: 0.9;
                  color: #000;
                  padding: 12px 18px;
                  font-weight: 700;
                  z-index: 9999;
                  border: 2px solid #0f0;
                  box-shadow: 0 0 0 2px #000 inset;
                  animation: slideIn 0.25s ease-out;
                  min-width: 240px;
                  text-align: center;
                `;
                document.body.appendChild(notif);

                if (withCountdown) {
                    // After `duration` ms show a 3..1 countdown, then a short final marker and remove
                    setTimeout(() => {
                        let countdown = 3;
                        notif.style.fontSize = '1.8rem';
                        const countdownInterval = setInterval(() => {
                            if (countdown > 0) {
                                notif.textContent = `[${countdown}]`;
                                countdown--;
                            } else {
                                // final marker
                                notif.textContent = '!';
                                notif.style.background = '#ff0';
                                notif.style.border = '2px solid #ff0';
                                clearInterval(countdownInterval);
                                setTimeout(() => notif.remove(), 800);
                            }
                        }, 1000);
                    }, duration);
                } else {
                    setTimeout(() => notif.remove(), duration);
                }
            } catch (e) {
                console.warn('adminShowNotif fallback:', text);
            }
        }

        // Afficher notification locale
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            
            if (type === 'error') {
                notif.style.background = '#ff4444';
            } else if (type === 'success') {
                notif.style.background = '#0f0';
            }
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 4000);
        }

    // Initialiser
    checkSes();
    </script>
    </body>
</html>