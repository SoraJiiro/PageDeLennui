<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Administration - PDE</title>

        <link rel="preload"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
            as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript>
            <link rel="stylesheet"
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
        </noscript>

        <link rel="stylesheet" type="text/css" href="css/common.css" />
        <link rel="stylesheet" type="text/css" href="css/stage1.css" />
        <link rel="stylesheet" type="text/css" href="css/stage3.css" />
        <link rel="stylesheet" type="text/css" href="css/admin.css" />
        <style>
            .admin-medals-wrap {
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: none !important;
                border: none !important;
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                padding: 10px 0;
                justify-content: flex-start;
                overflow: visible !important;
            }
            .admin-medals-wrap .medal {
                width: 80px !important;
                height: 80px !important;
                flex-shrink: 0;
            }
            .admin-medals-wrap .medal.shown::after {
                font-size: 2rem !important;
            }
            .admin-medals-wrap .medal .medal-index {
                font-size: 2rem !important;
            }
        </style>

        <link rel="icon" type="img/png" href="imgs/icon_d.png"
            media="(prefers-color-scheme: dark)" />
        <link rel="icon" type="img/png" href="imgs/icon_l.png"
            media="(prefers-color-scheme: light)" />
        <script defer type="module" src="js/notifications.js"></script>
        <script src="/js/uiColor.js" type="text/javascript"></script>
        <script defer src="/js/admin_pixelwar.js"></script>
    </head>
    <body>
        <button class="password-btn" onclick="requestUnlock()">Afficher</button>
        <div id="panel" class="panel">
            <div class="admin-container">
                <div class="admin-header">

                    <h1><i class="fa-solid fa-wrench"></i> PANEL
                        ADMIN</h1><div class="header-btns">
                        <button class="deco"
                            onclick="localStorage.removeItem('uiColor'); window.location.replace('/login');">Se
                            déconnecter</button>
                        <button class="del-other-admins"
                            onclick="disconnectOtherAdmins()">Déco
                            autres</button>
                        <button class="logs"
                            onclick="window.open('/admin/logs', '_blank');">Logs</button>
                        <button class="shutdown"
                            onclick="shutdownServer()">OFF</button>
                        <button class="hide"
                            onclick="toggleAdminPanel()">Cacher</button>
                        <button class="go-to-sondages"
                            onclick="window.open('./sondages.html');">Sondages</button>
                        <button class="tag-admin"
                            onclick="window.open('./demande-tag.html');">Tag</button>
                    </div>
                </div>

                <div class="admin-sections">
                    <!-- TRANSACTIONS -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-money-bill-transfer"></i>
                            /Transactions en attente</h2>
                        <div class="transactions-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>De</th>
                                        <th>À</th>
                                        <th>Montant</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-list">

                                </tbody>
                            </table>
                            <center>
                                <button onclick="refreshTransactions()"
                                    class="refresh-btn"><i
                                        class="fa-solid fa-rotate"></i>
                                    Actualiser</button>
                            </center>
                        </div>
                    </section>

                    <!-- PASSWORD REQUESTS -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-key"></i> /Demandes de Mot de
                            Passe</h2>
                        <div class="transactions-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Pseudo</th>
                                        <th>IP</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="password-requests-list">

                                </tbody>
                            </table>
                            <center>
                                <button onclick="refreshPasswordRequests()"
                                    class="refresh-btn"><i
                                        class="fa-solid fa-rotate"></i>
                                    Actualiser</button>
                            </center>
                        </div>
                    </section>

                    <!-- PFP REQUESTS -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-image"></i> /Demandes de
                            PFP</h2>
                        <div class="transactions-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Pseudo</th>
                                        <th>URL</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pfp-requests-list"></tbody>
                            </table>
                            <center>
                                <button onclick="refreshPfpRequests()"
                                    class="refresh-btn"><i
                                        class="fa-solid fa-rotate"></i>
                                    Actualiser</button>
                            </center>
                        </div>
                    </section>

                    <!-- Sections "Fichiers partagés" et "Logs actions fichiers" supprimées -->

                    <!-- BADGES CHAT -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-tags"></i> /Badges (chat)</h2>
                        <div class="transactions-container">
                            <div class="control-form">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="badgeId">ID</label>
                                        <input id="badgeId"
                                            placeholder="ex: star" />
                                    </div>
                                    <div class="form-field">
                                        <label for="badgeEmoji">Emoji</label>
                                        <input id="badgeEmoji"
                                            placeholder="⭐" />
                                    </div>
                                    <div class="form-field">
                                        <label for="badgeName">Nom</label>
                                        <input id="badgeName"
                                            placeholder="Star" />
                                    </div>
                                    <div class="form-field">
                                        <label>&nbsp;</label>
                                        <button onclick="createBadge()"
                                            class="btn"><i
                                                class="fa-solid fa-plus"></i>
                                            Créer</button>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="assignPseudo">Pseudo</label>
                                        <input id="assignPseudo"
                                            placeholder="Pseudo" />
                                    </div>
                                    <div class="form-field">
                                        <label for="assignBadgeId">Badge</label>
                                        <select id="assignBadgeId"></select>
                                    </div>
                                    <div class="form-field">
                                        <label>&nbsp;</label>
                                        <button onclick="assignBadge('add')"
                                            class="btn"><i
                                                class="fa-solid fa-check"></i>
                                            Donner</button>
                                    </div>
                                    <div class="form-field">
                                        <label>&nbsp;</label>
                                        <button onclick="assignBadge('remove')"
                                            class="btn btn-red"><i
                                                class="fa-solid fa-times"></i>
                                            Retirer</button>
                                    </div>
                                    <div class="form-field">
                                        <label>&nbsp;</label>
                                        <button onclick="refreshBadges()"
                                            class="btn"><i
                                                class="fa-solid fa-rotate"></i>
                                            Refresh</button>
                                    </div>
                                </div>
                            </div>

                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Emoji</th>
                                        <th>Nom</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="badges-catalog-list"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- ECONOMY DAILY CAP -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-coins"></i> /Cap quotidien
                            (casino)</h2>
                        <div class="transactions-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Pseudo</th>
                                        <th>Clicks</th>
                                        <th>Base</th>
                                        <th>Cap</th>
                                        <th>Earned</th>
                                        <th>Remaining</th>
                                        <th>Cap (potentiel)</th>
                                        <th>Date reset</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-cap-list"></tbody>
                            </table>
                            <center>
                                <button onclick="refreshDailyCap()"
                                    class="refresh-btn"><i
                                        class="fa-solid fa-rotate"></i>
                                    Actualiser</button>
                            </center>
                        </div>
                    </section>

                    <section class="admin-section">
                        <h2><i class="fa-solid fa-paintbrush"></i> /Pixel
                            War</h2>
                        <div class="transactions-container">
                            <div class="control-form">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>&nbsp;</label>
                                        <button onclick="pixelWarResetBoard()"
                                            class="btn btn-red">RESET
                                            BOARD</button>
                                    </div>
                                </div>
                                <hr style="border-color:#555; width:100%;">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="pw-x1">X1</label>
                                        <input id="pw-x1" type="number"
                                            placeholder="0">
                                    </div>
                                    <div class="form-field">
                                        <label for="pw-y1">Y1</label>
                                        <input id="pw-y1" type="number"
                                            placeholder="0">
                                    </div>
                                    <div class="form-field">
                                        <label for="pw-x2">X2</label>
                                        <input id="pw-x2" type="number"
                                            placeholder="200">
                                    </div>
                                    <div class="form-field">
                                        <label for="pw-y2">Y2</label>
                                        <input id="pw-y2" type="number"
                                            placeholder="200">
                                    </div>
                                    <div class="form-field">
                                        <label>&nbsp;</label>
                                        <button onclick="pixelWarResetArea()"
                                            class="btn btn-red">RESET
                                            AREA</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- LEADERBOARDS -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-trophy"></i>
                            /Leaderboards</h2>
                        <center>
                            <div class="leaderboard-tabs">
                                <button class="lb-tab active"
                                    data-board="clicker">Clicker</button>
                                <button class="lb-tab"
                                    data-board="dino">Dino</button>
                                <button class="lb-tab"
                                    data-board="flappy">Flappy
                                </button>
                                <button class="lb-tab"
                                    data-board="uno">UNO</button>
                                <button class="lb-tab"
                                    data-board="p4">P4</button>
                                <button class="lb-tab"
                                    data-board="blockblast">Block
                                    Blast</button>
                                <button class="lb-tab"
                                    data-board="snake">Snake</button>
                                <button class="lb-tab"
                                    data-board="motus">Motus</button>
                                <button class="lb-tab"
                                    data-board="2048">2048</button>
                                <button class="lb-tab"
                                    data-board="blackjack">Blackjack</button>
                                <button class="lb-tab"
                                    data-board="coinflip">Coin Flip</button>
                                <button class="lb-tab"
                                    data-board="mash">Mash</button>
                            </div>
                        </center>

                        <div class="leaderboard-content active"
                            data-board="clicker">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Clicks</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-clicker"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="dino">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-dino"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="flappy">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-flappy"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="uno">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Victoires</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-uno"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="p4">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Victoires</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-p4"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content"
                            data-board="blockblast">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Score</th>
                                        <th>Temps</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-blockblast"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="snake">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Score</th>
                                        <th>Temps</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-snake"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="motus">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Mots trouvés</th>
                                        <th>Essais</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-motus"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="2048">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-2048"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="blackjack">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Mains</th>
                                        <th>W/L</th>
                                        <th>Max Bet</th>
                                        <th>Double/BJ</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-blackjack"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="coinflip">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Parties</th>
                                        <th>W/L</th>
                                        <th>Max Bet</th>
                                        <th>Max Loss</th>
                                        <th>All-ins</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-coinflip"></tbody>
                            </table>
                        </div>

                        <div class="leaderboard-content" data-board="mash">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Pseudo</th>
                                        <th>Victoires</th>
                                    </tr>
                                </thead>
                                <tbody id="lb-mash"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- GESTION TRICHEURS -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-ban"></i> /Gestion
                            Tricheurs</h2>
                        <div class="admin-card">
                            <div class="input-group">
                                <label>Pseudo</label>
                                <input type="text"
                                    id="cheater-pseudo"
                                    style="width: 100%;
  padding: 12px;
  background: var(--bg-color);
  border: 2px solid var(--primary-color);
  color: var(--primary-color);
  font-size: 1rem;margin-top:10px;"
                                    placeholder="Pseudo">
                            </div>
                            <div class="btn-group"
                                style="margin-top: 10px; display: flex; gap: 10px;">
                                <button class="btn btn-red"
                                    onclick="addCheater()">Ajouter
                                    Tricheur</button>
                                <button class="btn"
                                    onclick="removeCheater()">Retirer
                                    Tricheur</button>
                            </div>
                            <div style="margin-top: 20px;">
                                <ul id="cheaters-list"
                                    style="list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px;">
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- CHAT LAN -->
                    <section class="admin-section" id="chat">
                        <h2><i class="fa-solid fa-comments"
                                style="margin-right:10px"></i>/Chat LAN</h2>
                        <div class="chat-card" role="region"
                            aria-label="Chat LAN">
                            <div class="chat-header">
                                <h3>Chat.exe</h3>
                                <div class="chat-status">
                                    <button class="btn btn-red"
                                        style="padding: 2px 8px; font-size: 0.8rem; margin-right: 10px;"
                                        onclick="clearChat()">Clear
                                        Chat</button>
                                    <span id="me"></span>
                                    <span id="usersCount"></span>
                                </div>
                            </div>
                            <div id="chat-messages" class="chat-messages"
                                aria-live="polite"></div>
                            <form id="chat-form" autocomplete="off"
                                autocorrect="off" class="chat-form">
                                <textarea id="chat-input" rows="1"
                                    placeholder="Écris ton message..."></textarea>
                                <button type="submit" title="Envoyer message"
                                    class="submit"><i
                                        class="fa-solid fa-circle-arrow-right"></i></button>
                            </form>
                        </div>
                    </section>

                    <!-- USER INFO -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-user"
                                style="margin-right: 10px;"></i>/Infos
                            Utilisateur</h2>

                        <div class="user-search">
                            <input type="text" id="userSearchInput"
                                placeholder="Rechercher un utilisateur par pseudo (sensible à la casse)..." />
                            <div
                                style="font-size:12px;color:#9a9a9a;margin-top:6px;">Case
                                Sensitive</div>
                        </div>

                        <div class="user-info-display" id="userInfoDisplay">
                            <h3 id="userInfoPseudo"
                                style="margin-bottom: 15px;"></h3>
                            <div id="userInfoStats"></div>
                        </div>
                    </section>

                    <!-- ADMINISTRATION -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-gear"></i> /Commandes</h2>

                        <div class="admin-controls">
                            <!-- Modifier Stats -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-chart-simple"></i>
                                    /Modifier Stats</h3>
                                <div class="control-form">
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label>Pseudo</label>
                                            <input type="text" id="modifyUser"
                                                placeholder="Pseudo (ou ALL pour cibler tout le monde)" />
                                        </div>
                                        <div class="form-field">
                                            <label>Stat ?</label>
                                            <select id="modifyStatType">
                                                <option
                                                    value="clicks">Clicker</option>
                                                <option
                                                    value="dinoScores">Dino</option>
                                                <option
                                                    value="flappyScores">Flappy</option>
                                                <option
                                                    value="unoWins">UNO</option>
                                                <option
                                                    value="p4Wins">P4</option>
                                                <option
                                                    value="blockblastScores">Block
                                                    Blast</option>
                                                <option
                                                    value="snakeScores">Snake</option>
                                                <option
                                                    value="motusScores">Motus</option>
                                                <option
                                                    value="scores2048">2048</option>
                                                <option
                                                    value="blackjackStats">Blackjack</option>
                                                <option
                                                    value="coinflipStats">Coin
                                                    Flip</option>
                                                <option value="pixelwar">Pixel
                                                    War</option>
                                                <option
                                                    value="mashWins">Mash</option>
                                                <option value="all">Toutes les
                                                    stats</option>
                                            </select>
                                        </div>
                                        <div class="form-field"
                                            id="statFieldContainer"
                                            style="display:none;">
                                            <label>Champ</label>
                                            <select id="modifyStatField">
                                                <!-- Populated by JS -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label>Nouvelle Valeur</label>
                                            <input type="number"
                                                id="modifyStatValue"
                                                placeholder="Nouvelle valeur" />
                                        </div>
                                        <div class="form-field">
                                            <label>Nouvelle durée (ms)</label>
                                            <input type="number"
                                                id="modifyStatTime"
                                                placeholder="Durée en ms" />
                                        </div>
                                        <div class="form-field">
                                            <label>Nouveaux essais</label>
                                            <input type="number"
                                                id="modifyStatTries"
                                                placeholder="Nb essais" />
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn"
                                                onclick="modifyStat()">
                                                <i class="fa-solid fa-pen"></i>
                                                Modifier
                                            </button>
                                            <button class="btn"
                                                onclick="addStat()">
                                                <i class="fa-solid fa-plus"></i>
                                                Ajouter
                                            </button>
                                            <button class="btn btn-red"
                                                onclick="removeStat()">
                                                <i
                                                    class="fa-solid fa-minus"></i>
                                                Retirer
                                            </button>
                                            <button class="btn"
                                                onclick="modifyTime()"
                                                title="Modifier le meilleur temps">
                                                <i
                                                    class="fa-solid fa-clock"></i>
                                                Modifier Temps
                                            </button>
                                            <button class="btn btn-red"
                                                onclick="removeTime()"
                                                title="Supprimer le meilleur temps">
                                                <i
                                                    class="fa-solid fa-trash-can"></i>
                                                Supprimer Temps
                                            </button>
                                            <button class="btn"
                                                onclick="modifyTries()"
                                                title="Modifier le nombre d'essais">
                                                <i
                                                    class="fa-solid fa-list-ol"></i>
                                                Modifier Essais
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gestion des Tags -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-tag"></i> /Tags</h3>
                                <div class="control-form">
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label>Pseudo</label>
                                            <input type="text" id="tagUser"
                                                placeholder="Pseudo" />
                                        </div>
                                        <div class="form-field">
                                            <label>Tag</label>
                                            <div style="display:flex; gap:5px;">
                                                <input type="text" id="tagValue"
                                                    placeholder="Tag..."
                                                    style="flex:1" />
                                            </div>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn"
                                                onclick="setTag()">
                                                <i
                                                    class="fa-solid fa-check"></i>
                                                Définir
                                            </button>
                                            <button class="btn btn-red"
                                                onclick="removeTag()">
                                                <i
                                                    class="fa-solid fa-trash"></i>
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Demandes de Tag -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-envelope"></i>
                                    /Demandes
                                    de Tag</h3>
                                <div class="control-form">
                                    <div id="tagRequestsList"
                                        style="max-height: 200px; overflow-y: auto;">
                                        <p>Chargement...</p>
                                    </div>
                                    <button class="btn"
                                        onclick="loadTagRequests()"
                                        style="margin-top:10px">Rafraîchir</button>
                                </div>
                            </div>

                            <!-- Supprimer Utilisateur -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-trash"></i> /Supprimer
                                    Utilisateur</h3>
                                <div class="control-form">
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label>Pseudo</label>
                                            <input type="text" id="deleteUser"
                                                placeholder="Pseudo à supprimer" />
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn btn-red"
                                                onclick="deleteUser()">
                                                <i
                                                    class="fa-solid fa-trash"></i>
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label>Leaderboard ?</label>
                                            <select id="clearLbType">
                                                <option
                                                    value="all">Tous</option>
                                                <option
                                                    value="clicker">Clicker</option>
                                                <option
                                                    value="dino">Dino</option>
                                                <option
                                                    value="flappy">Flappy</option>
                                                <option value="uno">UNO</option>
                                                <option value="p4">P4</option>
                                                <option value="blockblast">Block
                                                    Blast</option>
                                                <option
                                                    value="snake">Snake</option>
                                                <option
                                                    value="motus">Motus</option>
                                                <option
                                                    value="mash">Mash</option>
                                                <option
                                                    value="2048">2048</option>
                                            </select>
                                        </div>

                                        <div class="action-buttons">
                                            <button class="btn btn-red"
                                                onclick="clearFromLeaderboard()">
                                                <i
                                                    class="fa-solid fa-eraser"></i>
                                                Supprimer des Leaderboards
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reset Leaderboards (Global) -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-bomb"></i> /Reset
                                    Leaderboards (Global)</h3>
                                <div class="control-form">
                                    <p
                                        style="color: #ff4444; margin-bottom: 10px; font-size: 0.9em;">
                                        ⚠️ Attention : Cette action va créer un
                                        backup puis effacer TOUTES les stats
                                        (sauf Clicks).
                                    </p>
                                    <div class="action-buttons">
                                        <button class="btn btn-red"
                                            onclick="resetLeaderboard('all')"
                                            style="width: 100%; padding: 15px; font-size: 1.2em;">
                                            <i class="fa-solid fa-skull"></i>
                                            RESET TOUT (Sauf Clicks)
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Backups -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-history"></i>
                                    /Backups</h3>
                                <div class="control-form">
                                    <div id="backupsList"
                                        style="max-height: 200px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #333; padding: 5px;">
                                        <p>Chargement...</p>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn"
                                            onclick="createBackup()">
                                            <i class="fa-solid fa-save"></i>
                                            Créer Backup
                                        </button>
                                        <button class="btn"
                                            onclick="loadBackups()">
                                            <i class="fa-solid fa-sync"></i>
                                            Rafraîchir
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Notification Globale -->
                            <div class="control-group">
                                <h3><i class="fa-solid fa-bullhorn"></i>
                                    /Notif</h3>
                                <div class="control-form">
                                    <div class="form-field">
                                        <label>Message</label>
                                        <textarea id="notificationMessage"
                                            placeholder="Message à envoyer à tlm"></textarea>
                                    </div>
                                    <div class="form-field">
                                        <label id="cntdwnlbl">
                                            <input type="checkbox"
                                                id="countdownCheckbox">
                                            <span>Countdown ?</span>
                                        </label>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn"
                                            onclick="sendGlobalNotification()">
                                            <i class="fa-solid fa-bell"></i>
                                            Envoyer
                                            à Tous
                                        </button>
                                        <button class="btn"
                                            onclick="window.open('./annonces.html');">
                                            <i class="fa-solid fa-bullhorn"></i>
                                            Historique
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- BLACKLIST -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-ban"></i> /Blacklist</h2>
                        <div class="control-form">
                            <div style="margin-bottom:8px">IP(s) blacklistées:
                                <strong id="blacklistCount">0</strong></div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label>IP à bannir</label>
                                    <input type="text" id="blacklistInput"
                                        placeholder="127.0.0.1" />
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-red"
                                        onclick="addBanFromInput()">Bannir</button>
                                    <!--<button class="btn"
                                    onclick="loadBlacklist()">Rafraîchir</button>-->
                                </div>
                            </div>

                            <!-- textarea removed: blacklist managed via add/remove buttons -->

                            <div style="margin-top:12px">
                                <label>Liste actuelle</label>
                                <table
                                    style="width:100%;border-collapse:collapse;margin-top:6px"><tbody
                                        id="blacklistList"></tbody></table>
                            </div>
                        </div>
                    </section>

                    <!-- SONDAGES -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-poll"></i> /Sondages</h2>
                        <div class="admin-card">
                            <h3>Créer un sondage</h3>
                            <div class="input-group">
                                <label>Question</label>
                                <input type="text" id="surveyQuestion"
                                    placeholder="Question du sondage...">
                            </div>
                            <div class="input-group">
                                <label>Choix (un par ligne)</label>
                                <textarea id="surveyChoices" rows="4"
                                    placeholder="Choix 1&#10;Choix 2&#10;..."></textarea>
                            </div>
                            <button class="btn" onclick="createSurvey()">Lancer
                                le sondage</button>
                        </div>

                        <div class="admin-card" style="margin-top: 20px;">
                            <h3>Gestion des sondages</h3>
                            <div id="adminSurveyList"></div>
                        </div>
                    </section>

                    <!-- LOGS -->
                    <section class="admin-section">
                        <h2><i class="fa-solid fa-database"></i> /Logs</h2>
                        <center>
                            <iframe src="logs.html"
                                class="logs-frame"></iframe>
                        </center>
                    </section>
                </div>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript">
        let socket;
        let currentUser = null;
        let chatModule = null;

        async function checkSes() {
            const res = await fetch('/api/session');
            if (!res.ok) {
                window.location.href = '/login';
                return;
            }
            const data = await res.json();
            currentUser = data.pseudo;
            
            if (currentUser !== 'Admin') {
                window.location.href = '/';
                return;
            }

            try {
                chatModule = await import('/js/chat.js');
            } catch (err) {
                console.warn('Impossible de précharger le module de chat:', err);
                chatModule = null;
            }

            if (!socket) {
                initSocket();
            }
            loadTagRequests();
            loadAdminSurveys();
        }

        // Initialiser Socket.IO
        function initSocket() {
            // on crée la socket sans auto-connexion pour pouvoir initialiser
            // les handlers du module chat avant que le serveur n'émette des événements
            socket = io({
                query: { username: currentUser },
                autoConnect: false,
            });

            // Expose pour scripts admin externes (ex: admin_pixelwar.js)
            window.adminSocket = socket;
            window.socket = socket;

            if (window.initUiColor) {
                window.initUiColor(socket);
            }

            // initialiser le module chat (s'il a été préchargé)
            try {
                if (chatModule && typeof chatModule.initChat === 'function') {
                    chatModule.initChat(socket);
                }
            } catch (err) {
                console.warn('Erreur lors de l\'initialisation du module chat:', err);
            }

            // connecte après l'initialisation des handlers
            socket.connect();

            socket.on('connect', () => {
                console.log('> Connecté au serveur');
            });

            // Auto-reload sur modification de fichiers
            socket.on('reload', (data) => {
                const file = data?.file || '';
                // Recharger seulement les CSS sans reset de socket
                if (file.match(/\.css$/i)) {
                    document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                        const href = link.href.split('?')[0];
                        link.href = href + '?v=' + Date.now();
                    });
                } else if (file.match(/\.js$/i) || file.match(/\.html$/i)) {
                    // Pour les JS/HTML, reload complet nécessaire
                    window.location.reload();
                }
            });

            // Leaderboards
            socket.on('clicker:leaderboard', (data) => updateLeaderboard('clicker', data, 'score'));
            socket.on('dino:leaderboard', (data) => updateLeaderboard('dino', data, 'score'));
            socket.on('flappy:leaderboard', (data) => updateLeaderboard('flappy', data, 'score'));
            socket.on('uno:leaderboard', (data) => updateLeaderboard('uno', data, 'wins'));
            socket.on('p4:leaderboard', (data) => updateLeaderboard('p4', data, 'wins'));
            socket.on('blockblast:leaderboard', (data) => updateLeaderboard('blockblast', data, 'score'));
            socket.on('snake:leaderboard', (data) => updateLeaderboard('snake', data, 'score'));
            socket.on('motus:leaderboard', (data) => updateLeaderboard('motus', data, 'words'));
            socket.on('2048:leaderboard', (data) => updateLeaderboard('2048', data, 'score'));
            socket.on('mash:leaderboard', (data) => updateLeaderboard('mash', data, 'wins'));
            socket.on('blackjack:leaderboard', (data) => updateLeaderboard('blackjack', data, 'handsWon'));
            socket.on('coinflip:leaderboard', (data) => updateLeaderboard('coinflip', data, 'wins'));

            // Notifications globales (admin voit aussi le countdown)
            socket.on('system:notification', (data) => {
                const message = data && data.message ? data.message : 'Notification';
                const duration = (data && data.duration) ? data.duration : 8000;
                const withCountdown = !!(data && data.withCountdown);
                if (window.showNotif) {
                    window.showNotif(message, duration, withCountdown);
                } else if (window.PDENotifications?.show) {
                    window.PDENotifications.show(message, { duration, withCountdown });
                }
            });

            socket.on('system:redirect', (url) => {
                window.location.href = url;
            });

            // Blacklist admin socket handlers
            socket.on('admin:blacklist:result', (res) => {
                if (!res) return;
                if (!res.success) return showNotification(`❌ ${res.message || 'Erreur blacklist'}`, 'error');
                window.__adminBlacklistData = res.data || { alwaysBlocked: [] };
                window.__adminBlacklistForced = Array.isArray(res.forced) ? res.forced : [];
                renderBlacklist();
            });

            socket.on('admin:blacklist:updated', (alwaysBlocked) => {
                window.__adminBlacklistData = { alwaysBlocked: Array.isArray(alwaysBlocked) ? alwaysBlocked : [] };
                if (!Array.isArray(window.__adminBlacklistForced)) window.__adminBlacklistForced = [];
                renderBlacklist();
                showNotification('✅ Blacklist mise à jour', 'success');
            });
        }

        function updateLeaderboard(type, data, valueKey) {
            const tbody = document.getElementById(`lb-${type}`);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                let val = item[valueKey];
                if (typeof val === 'number') {
                    val = val.toLocaleString('fr-FR');
                }

                let extraTd = '';
                // Gestion spécifique pour afficher le temps si présent (BlockBlast / Snake)
                if ((type === 'blockblast' || type === 'snake')) {
                     const t = item.timeMs;
                     let timeTxt = '—';
                     if (typeof t === 'number') {
                        const totalSec = Math.floor(t / 1000);
                        const h = Math.floor(totalSec / 3600);
                        const m = Math.floor((totalSec % 3600) / 60);
                        const s = totalSec % 60;
                        if (h > 0) {
                            timeTxt = `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        } else {
                            timeTxt = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        }
                     }
                     extraTd = `<td>${timeTxt}</td>`;
                }

                if (type === 'motus') {
                    const tries = item.tries || 0;
                    extraTd = `<td>${tries}</td>`;
                }

                if (type === 'blackjack') {
                    // Mots clés: Mains | W/L | Max Bet | Double/BJ
                    const hands = item.handsPlayed || 0;
                    const won = item.handsWon || 0;
                    const lost = item.handsLost || 0;
                    const maxBet = (item.biggestBet || 0).toLocaleString('fr-FR');
                    const dbl = item.doubles || 0;
                    const bj = item.bjs || 0;

                    val = hands; // Override val used for main column if needed, or structured differently
                    
                    // Reconstruction complète pour blackjack car colonnes spécifiques
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.pseudo}</td>
                        <td>${hands}</td>
                        <td>${won} / ${lost}</td>
                        <td>${maxBet}</td>
                        <td>${dbl} / ${bj}</td>
                    `;
                    tbody.appendChild(tr);
                    return; // Skip default row construction
                }

                if (type === 'coinflip') {
                    // Rang | Pseudo | Parties | W/L | Max Bet | Max Loss | All-ins
                    const games = item.gamesPlayed || 0;
                    const won = item.wins || 0;
                    const lost = item.losses || 0;
                    const maxBet = (item.biggestBet || 0).toLocaleString('fr-FR');
                    const maxLoss = (item.biggestLoss || 0).toLocaleString('fr-FR');
                    const allins = item.allIns || 0;

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.pseudo}</td>
                        <td>${games}</td>
                        <td>${won} / ${lost}</td>
                        <td>${maxBet}</td>
                        <td>${maxLoss}</td>
                        <td>${allins}</td>
                    `;
                    tbody.appendChild(tr);
                    return; // Skip default row construction
                }

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.pseudo}</td>
                    <td>${val}</td>
                    ${extraTd}
                `;
                tbody.appendChild(tr);
            });
        }

        // Tabs Leaderboard
        document.querySelectorAll('.lb-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const board = tab.dataset.board;
                
                document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.leaderboard-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.querySelector(`.leaderboard-content[data-board="${board}"]`).classList.add('active');
            });
        });

        // --- Transactions ---
        async function refreshTransactions() {
            try {
                const res = await fetch('/api/admin/transactions');
                if (!res.ok) return;
                const transactions = await res.json();
                const pending = transactions.filter(t => t.status === 'pending');
                
                const tbody = document.getElementById('transactions-list');
                tbody.innerHTML = '';
                
                if (pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Aucune transaction en attente</td></tr>';
                    return;
                }

                pending.forEach(tx => {
                    // Gestion affichage ancien format vs nouveau format + IP
                    let fromDisplay = tx.from;
                    if (tx.fromIp) {
                        fromDisplay = `${tx.from} (${tx.fromIp})`;
                    }
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fromDisplay}</td>
                        <td>${tx.to}</td>
                        <td>${tx.amount.toLocaleString()}</td>
                        <td>${new Date(tx.date).toLocaleString()}</td>
                        <td>
                            <button onclick="approveTransaction('${tx.id}')" class="btn-approve" style="background:#4CAF50; color:white; border:none; padding:5px 10px; cursor:pointer; margin-right:5px;"><i class="fa-solid fa-check"></i></button>
                            <button onclick="rejectTransaction('${tx.id}')" class="btn-reject" style="background:#f44336; color:white; border:none; padding:5px 10px; cursor:pointer;"><i class="fa-solid fa-times"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function approveTransaction(id) {
            if (!confirm('Valider cette transaction ?')) return;
            try {
                const res = await fetch('/api/admin/transactions/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    showNotification('Transaction approuvée', 'success');
                    refreshTransactions();
                } else {
                    showNotification('Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function rejectTransaction(id) {
            if (!confirm('Refuser cette transaction ?')) return;
            try {
                const res = await fetch('/api/admin/transactions/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    showNotification('Transaction refusée', 'success');
                    refreshTransactions();
                } else {
                    showNotification('Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Password Requests ---
        async function refreshPasswordRequests() {
            try {
                const res = await fetch('/api/admin/password-requests');
                if (!res.ok) return;
                const requests = await res.json();
                const pending = requests.filter(r => r.status === 'pending');
                
                const tbody = document.getElementById('password-requests-list');
                tbody.innerHTML = '';
                
                if (pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Aucune demande</td></tr>';
                    return;
                }

                pending.forEach(req => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${req.pseudo}</td>
                        <td>${req.ip || '?'}</td>
                        <td>${new Date(req.date).toLocaleString()}</td>
                        <td>
                            <button onclick="handlePasswordRequest('${req.id}', true)" class="btn-approve" 
                                style="background:#4CAF50; color:white; border:none; padding:5px 10px; cursor:pointer; margin-right:5px;"
                                title="Approuver et changer le mot de passe">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            <button onclick="handlePasswordRequest('${req.id}', false)" class="btn-reject" 
                                style="background:#f44336; color:white; border:none; padding:5px 10px; cursor:pointer;"
                                title="Rejeter">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Erreur refreshPasswordRequests", e);
            }
        }

        // --- PFP Requests ---
        async function refreshPfpRequests() {
            try {
                const res = await fetch('/api/admin/pfp/requests');
                if (!res.ok) return;
                const requests = await res.json();
                const pending = requests.filter(r => r.status === 'pending');

                const tbody = document.getElementById('pfp-requests-list');
                if (!tbody) return;
                tbody.innerHTML = '';

                if (pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Aucune demande</td></tr>';
                    return;
                }

                pending.forEach(req => {
                    const safeUrl = (req.url || '').toString();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${req.pseudo}</td>
                        <td style="max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <a href="${safeUrl}" target="_blank" rel="noopener">${safeUrl}</a>
                        </td>
                        <td>${new Date(req.createdAt || req.date || Date.now()).toLocaleString()}</td>
                        <td>
                            <button onclick="approvePfp('${req.id}')" class="btn-approve" style="background:#4CAF50; color:white; border:none; padding:5px 10px; cursor:pointer; margin-right:5px;" title="Approuver">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            <button onclick="rejectPfp('${req.id}')" class="btn-reject" style="background:#f44336; color:white; border:none; padding:5px 10px; cursor:pointer;" title="Refuser">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Erreur refreshPfpRequests', e);
            }
        }

        async function approvePfp(id) {
            if (!confirm('Approuver cette PFP ?')) return;
            try {
                const res = await fetch('/api/admin/pfp/requests/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    showNotification('PFP approuvée', 'success');
                    refreshPfpRequests();
                } else {
                    showNotification('Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function rejectPfp(id) {
            const reason = prompt('Raison du refus ? (optionnel)') || '';
            if (!confirm('Refuser cette PFP ?')) return;
            try {
                const res = await fetch('/api/admin/pfp/requests/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, reason })
                });
                if (res.ok) {
                    showNotification('PFP refusée', 'success');
                    refreshPfpRequests();
                } else {
                    showNotification('Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Badges (chat) ---
        let _badgesCache = null;
        async function refreshBadges() {
            try {
                const res = await fetch('/api/admin/badges');
                if (!res.ok) return;
                const data = await res.json();
                _badgesCache = data;
                const catalog = data.catalog || {};

                const tbody = document.getElementById('badges-catalog-list');
                if (tbody) {
                    tbody.innerHTML = '';
                    const entries = Object.entries(catalog).sort((a,b)=>a[0].localeCompare(b[0]));
                    if (entries.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Aucun badge</td></tr>';
                    } else {
                        entries.forEach(([id, def]) => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${id}</td>
                                <td>${def.emoji || ''}</td>
                                <td>${def.name || ''}</td>
                                <td>
                                    <button onclick="deleteBadge('${id}')" style="background:#f44336; color:white; border:none; padding:5px 10px; cursor:pointer;" title="Supprimer">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                }

                const select = document.getElementById('assignBadgeId');
                if (select) {
                    select.innerHTML = '';
                    Object.entries(catalog).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([id, def]) => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = `${id} ${def.emoji ? '(' + def.emoji + ')' : ''} - ${def.name || ''}`;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Erreur refreshBadges', e);
            }
        }

        async function createBadge() {
            const id = (document.getElementById('badgeId')?.value || '').trim();
            const emoji = (document.getElementById('badgeEmoji')?.value || '').trim();
            const name = (document.getElementById('badgeName')?.value || '').trim();
            if (!id || !emoji || !name) {
                showNotification('Champs manquants', 'error');
                return;
            }
            try {
                const res = await fetch('/api/admin/badges/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, emoji, name })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok) {
                    showNotification('Badge créé', 'success');
                    refreshBadges();
                } else {
                    showNotification(data.message || 'Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function deleteBadge(id) {
            if (!confirm(`Supprimer le badge ${id} ?`)) return;
            try {
                const res = await fetch('/api/admin/badges/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    showNotification('Badge supprimé', 'success');
                    refreshBadges();
                } else {
                    showNotification('Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function assignBadge(action) {
            const pseudo = (document.getElementById('assignPseudo')?.value || '').trim();
            const badgeId = (document.getElementById('assignBadgeId')?.value || '').trim();
            if (!pseudo || !badgeId) {
                showNotification('Pseudo/Badge manquants', 'error');
                return;
            }
            try {
                const res = await fetch('/api/admin/badges/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo, badgeId, action })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok) {
                    showNotification(action === 'remove' ? 'Badge retiré' : 'Badge donné', 'success');
                } else {
                    showNotification(data.message || 'Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Cap quotidien (casino only) ---
        async function refreshDailyCap() {
            try {
                const tbody = document.getElementById('daily-cap-list');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Chargement...</td></tr>';

                const res = await fetch('/api/admin/economy/daily-cap');
                if (!res.ok) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Erreur chargement</td></tr>';
                    return;
                }
                const data = await res.json();
                const rows = Array.isArray(data.rows) ? data.rows : [];

                tbody.innerHTML = '';
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Aucune donnée</td></tr>';
                    return;
                }

                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    const fmt = (n) => (typeof n === 'number' ? n.toLocaleString('fr-FR') : '—');
                    tr.innerHTML = `
                        <td>${r.pseudo}</td>
                        <td>${fmt(r.currentClicks)}</td>
                        <td>${fmt(r.baseClicks)}</td>
                        <td>${fmt(r.cap)}</td>
                        <td>${fmt(r.earned)}</td>
                        <td>${fmt(r.remaining)}</td>
                        <td>${fmt(r.capPotential)}</td>
                        <td>${r.date || '—'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Erreur refreshDailyCap', e);
            }
        }

        async function handlePasswordRequest(requestId, approve) {
            const action = approve ? "approuver" : "rejeter";
            if (!confirm(`Voulez-vous vraiment ${action} cette demande de changement de mot de passe ?`)) return;

            try {
                const res = await fetch('/api/admin/approve-password-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId, approve })
                });

                const data = await res.json();
                if (res.ok && data.success) {
                    showNotification(`Demande ${approve ? 'approuvée' : 'rejetée'} avec succès`, 'success');
                    refreshPasswordRequests();
                } else {
                    showNotification(`Erreur: ${data.message || 'inconnue'}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showNotification("Erreur serveur", 'error');
            }
        }

        // Initial load
        refreshTransactions();
        refreshPasswordRequests();
        refreshPfpRequests();
        refreshBadges();
        refreshDailyCap();

        // Recherche utilisateur
        document.getElementById('userSearchInput').addEventListener('input', async (e) => {
            const pseudo = e.target.value.trim();
            if (!pseudo) {
                document.getElementById('userInfoDisplay').classList.remove('visible');
                return;
            }

            try {
                const res = await fetch(`/api/admin/user-info?pseudo=${encodeURIComponent(pseudo)}`);
                if (!res.ok) {
                    showNotification('❌ Utilisateur non trouvé', 'error');
                    document.getElementById('userInfoDisplay').classList.remove('visible');
                    return;
                }
                
                const data = await res.json();
                displayUserInfo(data);
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la recherche', 'error');
            }
        });

        function displayUserInfo(data) {
            const display = document.getElementById('userInfoDisplay');
            const pseudoEl = document.getElementById('userInfoPseudo');
            const statsEl = document.getElementById('userInfoStats');
            
            pseudoEl.innerHTML = `<i class="fa-solid fa-user"></i> ${data.pseudo}`;
            const metaHtml = `
                <div class="user-meta">
                    <div class="user-stat">
                        <span class="label">ID:</span>
                        <span class="value">${data.id || '—'}</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Créé le:</span>
                        <span class="value">${data.createdAt ? new Date(data.createdAt).toLocaleString() : '—'}</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Créé par (IP):</span>
                        <span class="value">${data.createdFromIp || '—'}</span>
                    </div>
                </div>
            `;

            statsEl.innerHTML = `
                <div class="user-stat">
                    <span class="label">Clicks (Clicker):</span>
                    <span class="value">${data.clicks || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score Dino:</span>
                    <span class="value">${data.dinoScore || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score Flappy:</span>
                    <span class="value">${data.flappyScore || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Victoires UNO:</span>
                    <span class="value">${data.unoWins || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Victoires P4:</span>
                    <span class="value">${data.p4Wins || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score Block Blast:</span>
                    <span class="value">${data.blockblastScore || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Score 2048:</span>
                    <span class="value">${data.score2048 || 0}</span>
                </div>
                <div class="user-stat">
                    <span class="label">Motus (Mots/Essais):</span>
                    <span class="value">${
                        data.motusScores 
                        ? (typeof data.motusScores === 'object' ? `${data.motusScores.words} / ${data.motusScores.tries}` : `${data.motusScores} / ?`)
                        : '0 / 0'
                    }</span>
                    <span class="label">Motus mots trouvés / mots totaux :</span>
                    <span class="value">${
                        data.motusScores 
                        ? (typeof data.motusScores === 'object' ? `${data.motusScores.words} / ${data.motusTotalWords || '?'}` : `${data.motusScores} / ?`)
                        : '0 / 0'
                    }</span>
                        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                        <button type="button" class="btn btn-red" id="resetMotusBtn"> 
                            <i class="fa-solid fa-rotate-left"></i>
                            Reset mots trouvés (Motus)
                        </button>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <label style="font-size:0.9rem;margin-right:6px;">Essais:</label>
                            <input type="number" id="motusTriesInput" min="0" step="1" value="${(data.motusScores && typeof data.motusScores === 'object' && typeof data.motusScores.tries === 'number') ? data.motusScores.tries : 0}" style="width:80px;padding:6px;background:var(--bg-color);border:1px solid #444;color:var(--fg-color);" />
                            <button type="button" class="btn" id="modifyMotusBtn" data-pseudo="${(data.pseudo||'')}">
                                <i class="fa-solid fa-pen"></i>
                                Modifier
                            </button>
                        </div>
                    </div>
                </div>
                <div class="user-stat">
                    <span class="label">Médailles:</span>
                    <div class="medals-wrap admin-medals-wrap">
                        ${data.medals && data.medals.length > 0 
                            ? data.medals.map(m => {
                                let styleStr = '';
                                let innerContent = '';
                                const isSpecial = ['Bronze', 'Argent', 'Or', 'Diamant', 'Rubis', 'Saphir'].includes(m.name);
                                
                                if (m.colors && m.colors.length) {
                                    if (m.name.startsWith('Médaille') || m.name === 'Tricheur') {
                                        m.colors.forEach((c, i) => styleStr += `--grad${i+1}: ${c}; `);
                                    } else if (!isSpecial && m.name !== 'Légendaire' && m.name !== 'Rainbow') {
                                        const bg = m.colors.length > 1 
                                            ? `linear-gradient(120deg, ${m.colors[0]} 30%, ${m.colors[1]} 60%)` 
                                            : m.colors[0];
                                        styleStr = `background: ${bg} !important; border: 5px solid #fff;`;
                                    }
                                }

                                if (m.name === 'Légendaire') {
                                    innerContent = '<div class="medal-index">7</div>';
                                } else if (m.name.startsWith('Médaille')) {
                                    const num = m.name.replace('Médaille ', '');
                                    innerContent = `<div class="medal-index">${num}</div>`;
                                } else if (m.name === 'Tricheur') {
                                    innerContent = '<div class="medal-index"><i class="fa-solid fa-ban"></i></div>';
                                }

                                const titleContent = m.colors && m.colors.length > 0 
                                    ? `${m.name}\n${m.colors.join('\n')}`
                                    : m.name;

                                return `<div class="medal shown" data-name="${m.name}" style="${styleStr}" title="${titleContent}">${innerContent.replace("Prestige - ", "")}</div>`;
                            }).join('')
                            : '<span style="color:var(--primary-color)">0</span>'
                        }
                    </div>
                </div>
                <div class="user-stat">
                    <span class="label">Tag:</span>
                    <span class="value">${
                        typeof data.tag === 'object' && data.tag !== null
                            ? `<span style="color:${data.tag.color || 'inherit'}">${data.tag.text}</span>`
                            : (data.tag || '—')
                    }</span>
                </div>
            `;

            pwdLength = data.password ? data.password.length : 0;
            hashedPwdLength = data.password ? data.passwordHash.length : 0;

            const pwdHtml = `
                <div class="user-passwords">
                    <div class="user-stat">
                        <span class="label">MPD :</span>
                        <span class="value" id="pwdPlain">${data.password ? "•".repeat(pwdLength) : '—'}</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">MDP HASH :</span>
                        <span class="value" id="pwdHash">${data.passwordHash ? '•'.repeat(hashedPwdLength) : '—'}</span>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn" id="togglePwdBtn">Afficher les mdp</button>
                    </div>
                </div>
            `;

            // Préfixer par les meta si disponibles
            statsEl.innerHTML = metaHtml + pwdHtml + statsEl.innerHTML;

            display.classList.add('visible');

            // Attacher le comportement du bouton pour afficher/masquer les mdp
            const toggleBtn = document.getElementById('togglePwdBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const plainEl = document.getElementById('pwdPlain');
                    const hashEl = document.getElementById('pwdHash');
                    if (!plainEl || !hashEl) return;

                    const visible = plainEl.dataset.visible === '1';
                    if (visible) {
                        plainEl.textContent = data.password ? '••••••' : '—';
                        hashEl.textContent = data.passwordHash ? '••••••' : '—';
                        plainEl.dataset.visible = '0';
                        toggleBtn.textContent = 'Afficher les mdp';
                    } else {
                        plainEl.textContent = data.password || '—';
                        hashEl.textContent = data.passwordHash || '—';
                        plainEl.dataset.visible = '1';
                        toggleBtn.textContent = 'Masquer les mdp';
                    }
                });
                // initialiser état masqué
                const plainElInit = document.getElementById('pwdPlain');
                if (plainElInit) plainElInit.dataset.visible = '0';
            }

                // Attacher listeners pour Motus (reset + modifier essais)
                const resetBtn = document.getElementById('resetMotusBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => resetMotusFoundWords(data.pseudo));
                }

                const modBtn = document.getElementById('modifyMotusBtn');
                if (modBtn) {
                    modBtn.addEventListener('click', () => modifyMotusTries(modBtn.dataset.pseudo || data.pseudo));
                }
        }

        async function resetMotusFoundWords(pseudo) {
            if (!pseudo) return;

            const ok = confirm(
                `Reset les mots trouvés Motus de ${pseudo} ?\n\nCela remet aussi à zéro ses essais et sa liste de mots déjà trouvés.`
            );
            if (!ok) return;

            try {
                const res = await fetch('/api/admin/motus/reset-found-words', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });

                const payload = await res.json().catch(() => ({}));
                if (res.ok && payload.success) {
                    showNotification(`✅ Motus reset pour ${pseudo}`, 'success');

                    // refresh la fiche utilisateur
                    const s = await fetch(`/api/admin/user-info?pseudo=${encodeURIComponent(pseudo)}`);
                    if (s.ok) {
                        const refreshed = await s.json();
                        displayUserInfo(refreshed);
                    }
                } else {
                    showNotification(`Erreur: ${payload.message || 'inconnue'}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showNotification('Erreur serveur', 'error');
            }
        }

        // Modifier le nombre d'essais Motus pour un joueur
        async function modifyMotusTries(pseudo) {
            // Normalize pseudo: remove surrounding quotes if present
            try {
                if (typeof pseudo === 'string') {
                    pseudo = pseudo.trim();
                    if ((pseudo.startsWith('"') && pseudo.endsWith('"')) || (pseudo.startsWith("'") && pseudo.endsWith("'"))) {
                        pseudo = pseudo.slice(1, -1);
                    }
                }
            } catch (e) { /* ignore */ }

            // Fallback: try to read pseudo from displayed user info
            if (!pseudo) {
                const pEl = document.getElementById('userInfoPseudo');
                if (pEl) {
                    // remove icon if present
                    const txt = pEl.textContent || '';
                    pseudo = txt.replace(/^[^\s]+\s*/, '').trim();
                }
            }

            const input = document.getElementById('motusTriesInput');
            if (!pseudo || !input) {
                showNotification('⚠️ Veuillez sélectionner un utilisateur et renseigner les essais', 'error');
                return;
            }

            const tries = parseInt(input.value, 10);
            if (isNaN(tries) || tries < 0) {
                showNotification('⚠️ Valeur d\'essais invalide', 'error');
                return;
            }

            if (!confirm(`Modifier le nombre d'essais Motus de ${pseudo} à ${tries} ?`)) return;

            try {
                const res = await fetch('/api/admin/modify-tries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo, tries })
                });
                const data = await res.json().catch(()=>({}));
                if (res.ok) {
                    showNotification('✅ Essais Motus modifiés', 'success');
                    // refresh la fiche utilisateur
                    const s = await fetch(`/api/admin/user-info?pseudo=${encodeURIComponent(pseudo)}`);
                    if (s.ok) {
                        const refreshed = await s.json();
                        displayUserInfo(refreshed);
                    }
                } else {
                    showNotification(data.message || 'Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
                showNotification('Erreur serveur', 'error');
            }
        }

        // Setup Stat Field Selector
        const complexStats = {
            'blackjackStats': [
                { value: 'wins', label: 'Victoires' },
                { value: 'losses', label: 'Défaites' },
                { value: 'draws', label: 'Égalités' },
                { value: 'blackjacks', label: 'Blackjacks' },
                { value: 'doubles', label: 'Doubles' }
            ],
            'coinflipStats': [
                { value: 'wins', label: 'Victoires' },
                { value: 'losses', label: 'Défaites' },
                { value: 'allIns', label: 'All-ins' },
                { value: 'highestWin', label: 'Plus gros gain' },
                { value: 'totalWon', label: 'Total Gagné' },
                { value: 'totalLost', label: 'Total Perdu' }
            ],
            'pixelwar': [
                { value: 'pixels', label: 'Pixels (Stock)' },
                { value: 'maxPixels', label: 'Stockage Max' }
            ]
        };

        const modifyStatTypeSelect = document.getElementById('modifyStatType');
        if (modifyStatTypeSelect) {
            modifyStatTypeSelect.addEventListener('change', function() {
                const val = this.value;
                const container = document.getElementById('statFieldContainer');
                const select = document.getElementById('modifyStatField');
                
                select.innerHTML = '';
                
                if (complexStats[val]) {
                    container.style.display = 'block';
                    complexStats[val].forEach(opt => {
                        const el = document.createElement('option');
                        el.value = opt.value;
                        el.innerText = opt.label;
                        select.appendChild(el);
                    });
                } else {
                    container.style.display = 'none';
                }
            });
        }

                // Modifier Stat
                async function modifyStat() {
                    const pseudo = document.getElementById('modifyUser').value.trim();
                    const statType = document.getElementById('modifyStatType').value;
                    let field = null;
                    let value = parseInt(document.getElementById('modifyStatValue').value);
                    // support for Motus tries: if statType is motusScores and modifyStatValue is empty,
                    // fallback to the "Nouveaux essais" input
                    if ((isNaN(value) || value === null) && statType === 'motusScores') {
                        const triesVal = parseInt(document.getElementById('modifyStatTries').value, 10);
                        if (!isNaN(triesVal)) {
                            value = triesVal;
                            // indicate we are changing the 'tries' field
                            field = 'tries';
                        }
                    }
          const fieldSelect = document.getElementById('modifyStatField');
          if (document.getElementById('statFieldContainer').style.display !== 'none') {
             field = fieldSelect.value;
          }

          if (!pseudo || isNaN(value)) {
            showNotification('⚠️ Veuillez remplir tous les champs', 'error');
            return;
          }

          const targetAll = pseudo.toUpperCase() === 'ALL';
          let confirmMsg = targetAll 
            ? `Modifier ${statType} de ALL LES JOUEURS à ${value} ?`
            : `Modifier ${statType} de ${pseudo} à ${value} ?`;

          if (field) {
            confirmMsg = targetAll
                ? `Modifier ${statType}.${field} de ALL LES JOUEURS à ${value} ?`
                : `Modifier ${statType}.${field} de ${pseudo} à ${value} ?`;
          }
          
          if (!confirm(confirmMsg)) return;
                    if (statType === 'all') {
                        if (!confirm(`⚠️ Vous êtes sur le point de modifier TOUTES les stats ${targetAll ? 'de ALL LES JOUEURS' : 'de ' + pseudo} à ${value} ! Confirmer ?`)) return;
                    }

                    // Special handling for Motus tries: use /modify-tries endpoint
                    if (statType === 'motusScores' && field === 'tries') {
                        if (targetAll) {
                            showNotification('⚠️ Modification des essais pour ALL non supportée', 'error');
                            return;
                        }

                        try {
                            const res = await fetch('/api/admin/modify-tries', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ pseudo, tries: value })
                            });
                            const data = await res.json().catch(()=>({}));
                            if (res.ok) {
                                showNotification('✅ Essais Motus modifiés', 'success');
                                if (socket) socket.emit('admin:refresh');
                                document.getElementById('modifyUser').value = '';
                                document.getElementById('modifyStatValue').value = '';
                            } else {
                                showNotification(data.message || 'Erreur', 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            showNotification('⚠️ Erreur lors de la modification', 'error');
                        }

                        return;
                    }

                    try {
                        const endpoint = targetAll ? '/api/admin/modify-all-users-stat' : '/api/admin/modify-stat';
                        const body = targetAll 
                            ? { statType, value, field }
                            : { pseudo, statType, value, field };

                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });

                        const data = await res.json();
            
                        if (res.ok) {
                            showNotification(`✅ ${data.message}`, 'success');
            socket.emit('admin:refresh');
            document.getElementById('modifyUser').value = '';
            document.getElementById('modifyStatValue').value = '';
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
    } catch (err) {
        console.error(err);
        showNotification('⚠️ Erreur lors de la modification', 'error');
    }
}

async function addStat() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const statType = document.getElementById('modifyStatType').value;
        let value = parseInt(document.getElementById('modifyStatValue').value);
        let field = null;
        if ((isNaN(value) || value === null) && statType === 'motusScores') {
                const triesVal = parseInt(document.getElementById('modifyStatTries').value, 10);
                if (!isNaN(triesVal)) {
                        value = triesVal;
                        field = 'tries';
                }
        }

        if (!pseudo || isNaN(value)) {
                showNotification('⚠️ Veuillez remplir tous les champs avec une valeur positive', 'error');
                return;
        }
  const fieldSelect = document.getElementById('modifyStatField');
  if (document.getElementById('statFieldContainer') && document.getElementById('statFieldContainer').style.display !== 'none') {
     field = fieldSelect.value;
  }

  const targetAll = pseudo.toUpperCase() === 'ALL';
  let confirmMsg = targetAll 
    ? `Ajouter ${value} à ${statType} de ALL LES JOUEURS ?`
    : `Ajouter ${value} à ${statType} de ${pseudo} ?`;
    
  if (field) {
     confirmMsg = targetAll 
      ? `Ajouter ${value} à ${statType}.${field} de ALL LES JOUEURS ?`
      : `Ajouter ${value} à ${statType}.${field} de ${pseudo} ?`;
  }
  
  if (!confirm(confirmMsg)) return;

  try {
        // If adding to Motus tries, compute new tries and call modify-tries
        if (statType === 'motusScores' && field === 'tries') {
            if (targetAll) {
                showNotification('⚠️ Ajout d\'essais pour ALL non supporté', 'error');
                return;
            }

            // fetch current user info to get current tries
            const curRes = await fetch(`/api/admin/user-info?pseudo=${encodeURIComponent(pseudo)}`);
            if (!curRes.ok) return showNotification('❌ Utilisateur introuvable', 'error');
            const cur = await curRes.json().catch(()=>({}));
            const currentTries = (cur.motusScores && typeof cur.motusScores === 'object') ? (cur.motusScores.tries || 0) : 0;
            const newTries = Math.max(0, currentTries + value);

            const res = await fetch('/api/admin/modify-tries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pseudo, tries: newTries })
            });
            const data = await res.json();
            if (res.ok) {
                showNotification(`✅ Essais Motus augmentés (total: ${newTries})`, 'success');
                socket.emit('admin:refresh');
                document.getElementById('modifyUser').value = '';
                document.getElementById('modifyStatValue').value = '';
            } else {
                showNotification(`❌ ${data.message}`, 'error');
            }

            return;
        }

        const endpoint = targetAll ? '/api/admin/add-all-users-stat' : '/api/admin/add-stat';
        const body = targetAll 
            ? { statType, value, field }
            : { pseudo, statType, value, field };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    
    if (res.ok) {
      showNotification(`✅ ${data.message}`, 'success');
      socket.emit('admin:refresh');
      document.getElementById('modifyUser').value = '';
      document.getElementById('modifyStatValue').value = '';
    } else {
      showNotification(`❌ ${data.message}`, 'error');
    }
  } catch (err) {
    console.error(err);
    showNotification('⚠️ Erreur lors de l\'ajout', 'error');
  }
}

async function removeStat() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const statType = document.getElementById('modifyStatType').value;
        let value = parseInt(document.getElementById('modifyStatValue').value);
        let field = null;
        if ((isNaN(value) || value === null) && statType === 'motusScores') {
                const triesVal = parseInt(document.getElementById('modifyStatTries').value, 10);
                if (!isNaN(triesVal)) {
                        value = triesVal;
                        field = 'tries';
                }
        }

        if (!pseudo || isNaN(value) || value <= 0) {
                showNotification('⚠️ Veuillez remplir tous les champs avec une valeur positive', 'error');
                return;
        }
  const fieldSelect = document.getElementById('modifyStatField');
  if (document.getElementById('statFieldContainer') && document.getElementById('statFieldContainer').style.display !== 'none') {
     field = fieldSelect.value;
  }

  const targetAll = pseudo.toUpperCase() === 'ALL';
  let confirmMsg = targetAll 
    ? `Retirer ${value} de ${statType} de ALL LES JOUEURS ?`
    : `Retirer ${value} de ${statType} de ${pseudo} ?`;

  if (field) {
     confirmMsg = targetAll 
      ? `Retirer ${value} de ${statType}.${field} de ALL LES JOUEURS ?`
      : `Retirer ${value} de ${statType}.${field} de ${pseudo} ?`;
  }
  
  if (!confirm(confirmMsg)) return;

  try {
                // If removing from Motus tries, compute new tries and call modify-tries
                if (statType === 'motusScores' && field === 'tries') {
                        if (targetAll) {
                                showNotification('⚠️ Retrait d\'essais pour ALL non supporté', 'error');
                                return;
                        }

                        const curRes = await fetch(`/api/admin/user-info?pseudo=${encodeURIComponent(pseudo)}`);
                        if (!curRes.ok) return showNotification('❌ Utilisateur introuvable', 'error');
                        const cur = await curRes.json().catch(()=>({}));
                        const currentTries = (cur.motusScores && typeof cur.motusScores === 'object') ? (cur.motusScores.tries || 0) : 0;
                        const newTries = Math.max(0, currentTries - value);

                        const res = await fetch('/api/admin/modify-tries', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ pseudo, tries: newTries })
                        });
                        const data = await res.json();
                        if (res.ok) {
                                showNotification(`✅ Essais Motus mis à jour (total: ${newTries})`, 'success');
                                socket.emit('admin:refresh');
                                document.getElementById('modifyUser').value = '';
                                document.getElementById('modifyStatValue').value = '';
                        } else {
                                showNotification(`❌ ${data.message}`, 'error');
                        }

                        return;
                }

                const endpoint = targetAll ? '/api/admin/remove-all-users-stat' : '/api/admin/remove-stat';
                const body = targetAll 
                        ? { statType, value, field }
                        : { pseudo, statType, value, field };

        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const data = await res.json();

        if (res.ok) {
            showNotification(`✅ ${data.message}`, 'success');
            socket.emit('admin:refresh');
            document.getElementById('modifyUser').value = '';
            document.getElementById('modifyStatValue').value = '';
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
  } catch (err) {
    console.error(err);
    showNotification('⚠️ Erreur lors de la suppression', 'error');
  }
}

// Modifier / Supprimer les best-times (snake, blockblast)
async function modifyTime() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const board = document.getElementById('modifyStatType').value;
    const time = parseInt(document.getElementById('modifyStatTime').value);

    if (!pseudo || isNaN(time) || time < 0) {
        showNotification('⚠️ Veuillez entrer un pseudo et une durée valide (ms)', 'error');
        return;
    }

            const allowed = { snakeScores: 'snake', blockblastScores: 'blockblast' };
            if (!allowed[board]) {
                showNotification('⚠️ Sélectionnez Snake ou Block Blast dans Stat ?', 'error');
                return;
            }

    if (!confirm(`Définir la durée (${time} ms) pour ${pseudo} sur ${allowed[board]} ?`)) return;

    try {
        const res = await fetch('/api/admin/modify-time', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pseudo, boardType: allowed[board], time })
        });
        const data = await res.json();
        if (res.ok) {
            showNotification(`✅ ${data.message}`, 'success');
            if (socket) socket.emit('admin:refresh');
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
    } catch (e) {
        console.error(e);
        showNotification('⚠️ Erreur lors de la modification du temps', 'error');
    }
}

async function removeTime() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const board = document.getElementById('modifyStatType').value;

    if (!pseudo) {
        showNotification('⚠️ Veuillez entrer un pseudo', 'error');
        return;
    }

    const allowed = { snakeScores: 'snake', blockblastScores: 'blockblast' };
    if (!allowed[board]) {
        showNotification('⚠️ Sélectionnez Snake ou Block Blast dans Stat ?', 'error');
        return;
    }

    if (!confirm(`Supprimer la durée enregistrée pour ${pseudo} sur ${allowed[board]} ?`)) return;

    try {
        const res = await fetch('/api/admin/remove-time', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pseudo, boardType: allowed[board] })
        });
        const data = await res.json();
        if (res.ok) {
            showNotification(`✅ ${data.message}`, 'success');
            if (socket) socket.emit('admin:refresh');
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
    } catch (e) {
        console.error(e);
        showNotification('⚠️ Erreur lors de la suppression du temps', 'error');
    }
}

async function modifyTries() {
    const pseudo = document.getElementById('modifyUser').value.trim();
    const board = document.getElementById('modifyStatType').value;
    const tries = parseInt(document.getElementById('modifyStatTries').value);

    if (!pseudo || isNaN(tries) || tries < 0) {
        showNotification('⚠️ Veuillez entrer un pseudo et un nombre d\'essais valide', 'error');
        return;
    }

    if (board !== 'motusScores') {
        showNotification('⚠️ Sélectionnez Motus dans Stat ?', 'error');
        return;
    }

    if (!confirm(`Définir ${tries} essais pour ${pseudo} sur Motus ?`)) return;

    try {
        const res = await fetch('/api/admin/modify-tries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pseudo, tries })
        });
        const data = await res.json();
        if (res.ok) {
            showNotification(`✅ ${data.message}`, 'success');
            if (socket) socket.emit('admin:refresh');
        } else {
            showNotification(`❌ ${data.message}`, 'error');
        }
    } catch (e) {
        console.error(e);
        showNotification('⚠️ Erreur lors de la modification des essais', 'error');
    }
}

        // Gestion des Tags
        async function setTag() {
            const pseudo = document.getElementById('tagUser').value.trim();
            const tag = document.getElementById('tagValue').value.trim();

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/set-tag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo, tag, color: "#ffffff" })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    document.getElementById('tagUser').value = '';
                    document.getElementById('tagValue').value = '';
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la définition du tag', 'error');
            }
        }

        async function removeTag() {
            const pseudo = document.getElementById('tagUser').value.trim();

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            if (!confirm(`Supprimer le tag de ${pseudo} ?`)) return;

            try {
                const res = await fetch('/api/admin/remove-tag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    document.getElementById('tagUser').value = '';
                    document.getElementById('tagValue').value = '';
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la suppression du tag', 'error');
            }
        }

        // Supprimer Utilisateur
        async function deleteUser() {
            const pseudo = document.getElementById('deleteUser').value.trim();

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            if (pseudo === 'Admin') {
                showNotification('❌ Impossible de supprimer cet administrateur', 'error');
                return;
            }

            if (!confirm(`⚠️ ATTENTION ⚠️\n\nSupprimer définitivement l'utilisateur "${pseudo}" ?\n\nToutes ses données seront perdues !`)) return;

            try {
                const res = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });

                const data = await res.json();
                
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    document.getElementById('deleteUser').value = '';
                    socket.emit('admin:refresh');
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors de la suppression', 'error');
            }
        }

        // Supprimer des Leaderboards (sans supprimer l'utilisateur)
        async function clearFromLeaderboard() {
            const pseudo = document.getElementById('deleteUser').value.trim();
            const boardType = document.getElementById('clearLbType').value;
            const resetTimes = !!document.getElementById('clearResetTimes') && document.getElementById('clearResetTimes').checked;

            if (!pseudo) {
                showNotification('⚠️ Veuillez entrer un pseudo', 'error');
                return;
            }

            const labelMap = {
                all: 'tous les leaderboards',
                clicker: 'Clicker',
                dino: 'Dino',
                flappy: 'Flappy',
                uno: 'UNO',
                p4: 'P4',
                blockblast: 'Block Blast',
                snake: 'Snake',
                motus: 'Motus',
                score2048: '2048',
                blackjack: 'Blackjack',
                coinflip: 'Coin Flip',
                mash: 'Mash'
            };

            const label = labelMap[boardType] || boardType;
            if (!confirm(`Supprimer les entrées ${label} de "${pseudo}" ?`)) return;

            try {
                const res = await fetch('/api/admin/clear-from-leaderboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo, boardType, resetTimes })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    if (socket) socket.emit('admin:refresh');
                } else {
                    showNotification(`❌ ${data.message || 'Erreur lors du nettoyage'}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors du nettoyage des leaderboards', 'error');
            }
        }

        // Blacklist admin helpers
        function loadBlacklist() {
            if (!socket) return;
            socket.emit('admin:blacklist:get');
        }

        socket && socket.on && socket.on('admin:blacklist:result', (res) => {
            if (!res) return;
            if (!res.success) return showNotification(`❌ ${res.message || 'Erreur blacklist'}`, 'error');
            window.__adminBlacklistData = res.data || { alwaysBlocked: [] };
            window.__adminBlacklistForced = Array.isArray(res.forced) ? res.forced : [];
            renderBlacklist();
        });

        socket && socket.on && socket.on('admin:blacklist:updated', (alwaysBlocked) => {
            // admin:blacklist:updated provides updated alwaysBlocked array; forced list remains from initial payload
            window.__adminBlacklistData = { alwaysBlocked: Array.isArray(alwaysBlocked) ? alwaysBlocked : [] };
            // ensure forced list exists
            if (!Array.isArray(window.__adminBlacklistForced)) window.__adminBlacklistForced = [];
            renderBlacklist();
            showNotification('✅ Blacklist mise à jour', 'success');
        });

        function renderBlacklist() {
            const data = window.__adminBlacklistData || { alwaysBlocked: [] };
            const arr = Array.isArray(data.alwaysBlocked) ? data.alwaysBlocked : [];
            const list = document.getElementById('blacklistList');
            const count = document.getElementById('blacklistCount');
            if (count) count.textContent = arr.length;
            if (!list) return;
            list.innerHTML = '';
            const forced = Array.isArray(window.__adminBlacklistForced) ? window.__adminBlacklistForced : [];
            arr.forEach(ip => {
                const tr = document.createElement('tr');
                const isForced = forced.includes(ip);
                if (isForced) {
                    tr.innerHTML = `<td style="padding:6px;border:1px solid #222">${ip} <span style="color:#b00;font-weight:700;margin-left:8px">(FORCÉE)</span></td><td style="padding:6px;border:1px solid #222;text-align:right"><button class="btn" disabled style="opacity:0.5;cursor:not-allowed">Unban</button></td>`;
                } else {
                    tr.innerHTML = `<td style="padding:6px;border:1px solid #222">${ip}</td><td style="padding:6px;border:1px solid #222;text-align:right"><button class="btn btn-red" onclick="removeBan('${ip}')">Unban</button></td>`;
                }
                list.appendChild(tr);
            });
        }

        function addBanFromInput() {
            const ip = document.getElementById('blacklistInput').value.trim();
            var ipv4Regex = /^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipv4Regex.test(ip)) return showNotification('⚠️ Entrez une IP IPv4 valide', 'error');
            if (!ip) return showNotification('⚠️ Entrez une IP', 'error');
            if (!confirm(`Bannir ${ip} ?`)) return;
            socket.emit('admin:blacklist:add', { ip });
            loadBlacklist();
            document.getElementById('blacklistInput').value = '';
        }

        function removeBan(ip) {
            if (!confirm(`Retirer le ban pour ${ip} ?`)) return;
            socket.emit('admin:blacklist:remove', { ip });
        }

        function disconnectOtherAdmins() {
            if (!confirm("Déconnecter toutes les autres sessions Admin ?")) return;
            socket.emit('admin:disconnect-others');
        }

        // load initial list when admin page connects
        (function waitForSocketThenLoad() {
            const attempt = () => {
                if (socket && socket.connected) {
                    loadBlacklist();
                } else {
                    setTimeout(attempt, 250);
                }
            };
            attempt();
        })();

        // Notification Globale
        function sendGlobalNotification() {
            const message = document.getElementById('notificationMessage').value.trim();
            const withCountdown = document.getElementById('countdownCheckbox').checked;

            if (!message) {
                showNotification('⚠️ Veuillez entrer un message', 'error');
                return;
            }

            const countdownText = withCountdown ? '\n\n(countdown ?)' : '';
            if (!confirm(`Envoyer cette notification à tous les utilisateurs ?${countdownText}\n\n"${message}"`)) return;

            socket.emit('admin:global-notification', { message, withCountdown });
            showNotification(`✅ Notification envoyée à tous${withCountdown ? ' (avec countdown)' : ''}`, 'success');
            document.getElementById('notificationMessage').value = '';
            document.getElementById('countdownCheckbox').checked = false;
        }

        function showNotification(message, type = 'info') {
            const variant = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            if (window.PDENotifications?.showStatus) {
                window.PDENotifications.showStatus(message, variant);
                return;
            }
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;

            if (type === 'error') {
                notif.style.background = '#ff4444';
            } else if (type === 'success') {
                notif.style.background = '#0f0';
            }

            document.body.appendChild(notif);

            setTimeout(() => {
                notif.remove();
            }, 4000);
        }

        // Gestion Tricheurs
        function clearChat() {
            if (!confirm("⚠️ Effacer tout l'historique du chat ?\nCette action est irréversible.")) return;
            socket.emit('admin:chat:clear');
        }

        async function loadCheaters() {
            try {
                const res = await fetch('/api/admin/cheater/list');
                const cheaters = await res.json();
                const list = document.getElementById('cheaters-list');
                list.innerHTML = '';
                
                if (cheaters.length === 0) {
                    list.innerHTML = '<li style="color: #888;">Aucun tricheur</li>';
                    return;
                }

                cheaters.forEach(pseudo => {
                    const li = document.createElement('li');
                    li.textContent = pseudo;
                    li.style.padding = '5px';
                    li.style.cursor = 'pointer';
                    li.onclick = () => {
                        document.getElementById('cheater-pseudo').value = pseudo;
                    };
                    list.appendChild(li);
                });
            } catch (err) {
                console.error("Erreur chargement tricheurs", err);
            }
        }

        loadCheaters();

        async function addCheater() {
            const pseudo = document.getElementById('cheater-pseudo').value.trim();
            if (!pseudo) return showNotification('⚠️ Pseudo requis', 'error');

            try {
                const res = await fetch('/api/admin/cheater/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification('✅ Joueur ajouté aux tricheurs', 'success');
                    document.getElementById('cheater-pseudo').value = '';
                    loadCheaters();
                } else {
                    showNotification('❌ ' + data.message, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('❌ Erreur serveur', 'error');
            }
        }

        async function removeCheater() {
            const pseudo = document.getElementById('cheater-pseudo').value.trim();
            if (!pseudo) return showNotification('⚠️ Pseudo requis', 'error');

            try {
                const res = await fetch('/api/admin/cheater/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pseudo })
                });
                const data = await res.json();
                if (res.ok) {
                    loadCheaters();
                } else {
                    showNotification('❌ ' + data.message, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('❌ Erreur serveur', 'error');
            }
        }

        async function shutdownServer() {
            if (!confirm("⚠️ Êtes-vous sûr de vouloir éteindre le serveur ?\nCela coupera l'accès à tout le monde.")) return;
            
            try {
                const res = await fetch('/api/admin/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.redirect) {
                    window.location.replace(data.redirect);
                }
            } catch (err) {
                console.error(err);
                showNotification('❌ Erreur lors de l\'arrêt', 'error');
            }
        }

        // Gestion des demandes de Tag
        async function loadTagRequests() {
            const list = document.getElementById('tagRequestsList');
            try {
                const res = await fetch('/api/admin/tag/list');
                const requests = await res.json();
                
                if (requests.length === 0) {
                    list.innerHTML = '<p style="color:#888">Aucune demande en attente.</p>';
                    return;
                }

                list.innerHTML = '';
                requests.forEach(req => {
                    const div = document.createElement('div');
                    div.style.border = '1px solid #333';
                    div.style.padding = '10px';
                    div.style.marginBottom = '5px';
                    div.style.background = 'rgba(0,0,0,0.3)';
                    
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div>
                                <strong>${req.pseudo}</strong> veut le tag: <span style="color:var(--primary-color)">${req.tag}</span><br>
                                <small style="color:#aaa">${new Date(req.time).toLocaleString()}</small>
                            </div>
                            <div style="display:flex; gap:5px">
                                <button class="btn" onclick="respondTag('${req.id}', 'accept')"><i class="fa-solid fa-check"></i></button>
                                <button class="btn btn-red" onclick="respondTag('${req.id}', 'reject')"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = '<p style="color:red">Erreur chargement.</p>';
            }
        }

        async function respondTag(requestId, action) {
            if (!confirm(action === 'accept' ? 'Accepter ce tag ?' : 'Refuser ce tag ?')) return;
            
            try {
                const res = await fetch('/api/admin/tag/respond', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId, action })
                });
                
                if (res.ok) {
                    showNotification('✅ Réponse envoyée', 'success');
                    loadTagRequests();
                } else {
                    showNotification('❌ Erreur', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- SURVEYS ---
        async function createSurvey() {
            const question = document.getElementById('surveyQuestion').value.trim();
            const choicesText = document.getElementById('surveyChoices').value.trim();
            
            if (!question) return alert('Question requise');
            if (!choicesText) return alert('Choix requis');
            
            const choices = choicesText.split('\n').map(c => c.trim()).filter(c => c);
            if (choices.length < 2) return alert('Il faut au moins 2 choix');

            try {
                const res = await fetch('/api/surveys/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, choices })
                });
                
                if (res.ok) {
                    showNotification('✅ Sondage créé', 'success');
                    document.getElementById('surveyQuestion').value = '';
                    document.getElementById('surveyChoices').value = '';
                    loadAdminSurveys();
                } else {
                    const data = await res.json();
                    alert('Erreur: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('Erreur serveur');
            }
        }

        async function loadAdminSurveys() {
            try {
                const res = await fetch('/api/surveys/list');
                const surveys = await res.json();
                const list = document.getElementById('adminSurveyList');
                list.innerHTML = '';

                surveys.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'admin-item';
                    
                    const statusClass = s.status === 'active' ? 'status-active' : 'status-closed';
                    
                    let votersHtml = '';
                    if (s.answers && Object.keys(s.answers).length > 0) {
                        votersHtml = '<div style="margin-top:10px; font-size:0.85rem; border-top:1px solid #333; padding-top:5px;"><strong>Détails des votes:</strong><ul style="padding-left:20px; margin:5px 0;">';
                        
                        // Grouper par choix pour une meilleure lisibilité
                        const votesByChoice = {};
                        s.choices.forEach((c, i) => votesByChoice[i] = []);
                        
                        Object.entries(s.answers).forEach(([pseudo, choiceIdx]) => {
                            if (votesByChoice[choiceIdx]) votesByChoice[choiceIdx].push(pseudo);
                        });

                        s.choices.forEach((choice, idx) => {
                            const voters = votesByChoice[idx];
                            if (voters && voters.length > 0) {
                                votersHtml += `<li><strong>${choice}</strong> (${voters.length}): <span style="color:#aaa">${voters.join(', ')}</span></li>`;
                            }
                        });
                        
                        votersHtml += '</ul></div>';
                    } else if (s.results && s.results.total > 0 && !s.answers) {
                         votersHtml = '<div style="margin-top:10px; font-size:0.85rem; color:#aaa;"><i>Détails masqués ou non disponibles</i></div>';
                    }

                    div.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#fff; margin-bottom: 4px;">${s.question}</div>
                            <div style="font-size:0.8rem; color:#aaa">
                                Status: <span class="${statusClass}">${s.status}</span> • 
                                Votes: ${s.results.total}
                            </div>
                            ${votersHtml}
                        </div>
                        <div style="display:flex; gap:5px; align-items: flex-start;">
                            ${s.status === 'active' ? 
                                `<button class="btn btn-red" onclick="closeSurvey('${s.id}')" title="Clore"><i class="fa-solid fa-stop"></i></button>` : 
                                ''}
                            <button class="btn btn-red" onclick="deleteSurvey('${s.id}')" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function closeSurvey(surveyId) {
            if (!confirm('Clore ce sondage ?')) return;
            try {
                const res = await fetch('/api/surveys/close', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ surveyId })
                });
                if (res.ok) loadAdminSurveys();
            } catch (e) { console.error(e); }
        }

        async function deleteSurvey(surveyId) {
            if (!confirm('Supprimer ce sondage ?')) return;
            try {
                const res = await fetch('/api/surveys/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ surveyId })
                });
                if (res.ok) loadAdminSurveys();
            } catch (e) { console.error(e); }
        }

        async function toggleAdminPanel(forceShow = false) {
            const panel = document.getElementById("panel");
            const passwordBtn = document.querySelector(".password-btn");

            if (forceShow) {
                panel.classList.remove("admin-hidden");
                passwordBtn.style.display = "none";
                return;
            }

            if (panel.classList.contains("admin-hidden")) {
                // Should use requestUnlock to show
                requestUnlock();
            } else {
                // Lock on server
                try {
                    await fetch('/api/admin/panel/lock', { method: 'POST' });
                    panel.classList.add("admin-hidden");
                    passwordBtn.style.display = "block";
                } catch (e) {
                    console.error("Lock error", e);
                }
            }
        }

        async function requestUnlock() {
            // Dynamic import to use the modal utility
            const { requestPassword } = await import('/js/util.js');
            const password = await requestPassword();
            
            if (password === null) return;

            try {
                const res = await fetch('/api/admin/panel/unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (data.success) {
                    toggleAdminPanel(true);
                } else {
                    showNotification('❌ Mot de passe incorrect', 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('❌ Erreur serveur', 'error');
            }
        }

        async function resetLeaderboard(type) {
            if (type !== 'all') return;

            if (!confirm(`⚠️ Êtes-vous SÛR de vouloir réinitialiser TOUS les leaderboards (sauf Clicks) ?\nUn backup sera créé automatiquement.`)) {
                return;
            }

            // Double confirmation pour éviter les accidents
            if (!confirm(`⚠️ Confirmation finale : Supprimer TOUTES les données ?`)) {
                return;
            }

            try {
                const res = await fetch('/api/admin/reset-leaderboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ boardType: 'all' })
                });

                const data = await res.json();

                if (res.ok) {
                    showNotification(`✅ ${data.message}`, 'success');
                    socket.emit('admin:refresh');
                    loadBackups();
                } else {
                    showNotification(`❌ ${data.message}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('⚠️ Erreur lors du reset', 'error');
            }
        }

        async function createBackup() {
            if (!confirm("Créer un backup manuel de toutes les stats (y compris Clicks) ?")) return;

            try {
                const res = await fetch('/api/admin/backups/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                
                if (res.ok) {
                    showNotification('✅ Backup créé avec succès', 'success');
                    loadBackups();
                } else {
                    showNotification('❌ ' + data.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showNotification('❌ Erreur création backup', 'error');
            }
        }

        async function loadBackups() {
            const list = document.getElementById('backupsList');
            try {
                const res = await fetch('/api/admin/backups/list');
                const backups = await res.json();
                
                if (backups.length === 0) {
                    list.innerHTML = '<p style="color:#888">0 backup.</p>';
                    return;
                }

                list.innerHTML = '';
                backups.forEach(backupId => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    div.style.padding = '8px';
                    div.style.borderBottom = '1px solid #444';
                    
                    const displayDatePt1 = backupId.replace('T', ' ').replace(/-/g, '/').slice(0, 10);
                    const displayDatePt2 = backupId.replace('T', ' ').replace(/-/g, ':').slice(11);

                    const displayDate = `${displayDatePt1} - ${displayDatePt2}`;

                    div.innerHTML = `
                        <span style="font-family:monospace">${displayDate}</span>
                        <button class="btn" style="padding: 4px 8px; font-size: 0.8em;" onclick="restoreBackup('${backupId}')">
                            <i class="fa-solid fa-rotate-left"></i> Restaurer
                        </button>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = '<p style="color:red">Erreur chargement backups.</p>';
            }
        }

        async function restoreBackup(backupId) {
            if (!confirm(`⚠️ Restaurer le backup du ${backupId} ?\nCela écrasera les données actuelles !`)) return;

            try {
                const res = await fetch('/api/admin/backups/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backupId })
                });
                
                const data = await res.json();
                if (res.ok) {
                    showNotification('✅ Backup restauré avec succès', 'success');
                    socket.emit('admin:refresh');
                } else {
                    showNotification('❌ ' + data.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showNotification('❌ Erreur restauration', 'error');
            }
        }

    // Restore panel state on load from server
    (async function initPanelState() {
        try {
            const res = await fetch('/api/admin/panel/state');
            const data = await res.json();
            if (data.hidden) {
                const panel = document.getElementById("panel");
                const passwordBtn = document.querySelector(".password-btn");
                if (panel && passwordBtn) {
                    panel.classList.add("admin-hidden");
                    passwordBtn.style.display = "block";
                }
            }
        } catch (e) {
            console.error("Failed to fetch panel state", e);
        }
    })();

    // Scroll Saver
    document.addEventListener("DOMContentLoaded", () => {
        const scrollPos = localStorage.getItem("adminScrollPos");
        if (scrollPos) window.scrollTo(0, parseInt(scrollPos));
        loadBackups();
    });

    window.addEventListener("beforeunload", () => {
        localStorage.setItem("adminScrollPos", window.scrollY);
    });

    // Initialiser
    checkSes();
    </script>
        <!-- Password Modal -->
        <div id="password-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>🔒 Confirmation requise</h3>
                <p>Entre ton mot de passe pour confirmer cette action :</p>
                <input type="password" id="password-input"
                    placeholder="Mot de passe" autocomplete="off">
                <div class="modal-buttons">
                    <button id="password-cancel"
                        class="btn-cancel">Annuler</button>
                    <button id="password-confirm"
                        class="btn-confirm">Confirmer</button>
                </div>
            </div>
        </div>
        <!-- File Preview Modal -->
        <div id="file-preview-modal" class="modal-overlay"
            style="display:none; align-items:center; justify-content:center;">
            <div id="file-preview-box" class="modal-content"
                style="max-width:90%; max-height:80%; overflow:auto;">
                <button id="file-preview-close" class="btn"
                    style="float:right;">Fermer</button>
                <div id="file-preview-content" style="color:#fff"></div>
            </div>
        </div>
    </body>
</html>