<!DOCTYPE html>
<html>

  <head>
    <title>Page de l'ennui</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer type="text/javascript" src="js/horloge.js"></script>
    <script defer type="text/javascript" src="js/affichage.js"></script>
    <script defer src="js/dino.js"></script>
    <link rel="stylesheet" type="text/css" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/stage1.css" />
    <link rel="stylesheet" type="text/css" href="css/stage2.css" />
    <link rel="stylesheet" type="text/css" href="css/stage3.css" />
    <link rel="stylesheet" type="text/css" href="css/stage4.css" />
    <link rel='shortcut icon' type="img/png" href="icon.png" />

    <script src="/socket.io/socket.io.js"></script>
    <script>
            document.addEventListener('DOMContentLoaded', () => {
    let estHote = false;
    const socket = io();

    socket.on("you:role", (data) => {
        estHote = data.estHote;


        let myName = null;

        const me = document.getElementById("me");
        const usersCount = document.getElementById("usersCount");
        const form = document.getElementById("chat-form");
        const input = document.getElementById("chat-input");
        const messages = document.getElementById("chat-messages");
        const submit = document.querySelector(".submit");

        // ========== CHAT ==========
        function addMessage({
            author,
            text,
            at,
            type = "user"
        }) {
            const el = document.createElement("div");
            el.className = `msg ${type}`;
            const time = at ?
                new Date(at).toLocaleString("fr-FR", {
                    dateStyle: "short",
                    timeStyle: "medium",
                }) :
                "";
            el.innerHTML = `
      			<div class="meta">
        			<span class="author">[${author}]</span>
        			<span class="time"><i>${time}</i></span>
      			</div>
      			<div class="text"></div>
    		`;
            el.querySelector(".text").textContent = text;
            messages.appendChild(el);
            messages.scrollTop = messages.scrollHeight;
        }

        socket.on("you:name", (name) => {
            myName = name || "inconnu";
            if (me) me.textContent = `Connect√© en tant que : ${myName} | >`;
        });

        socket.on("chat:history", (history) => {
            if (!Array.isArray(history)) return;
            history.forEach((msg) => {
                addMessage({
                    author: msg.name,
                    text: msg.text,
                    at: msg.at
                });
            });
        });

        socket.on("system:info", (text) =>
            addMessage({
                author: "Syst√®me",
                text,
                type: "system"
            })
        );

        socket.on("users:list", (list) => {
            if (usersCount)
                usersCount.textContent = `Utilisateurs en ligne: ${list.length}`;
        });

        socket.on("chat:message", (payload) =>
            addMessage({
                author: payload.name,
                text: payload.text,
                at: payload.at
            })
        );

        if (form) {
            form.addEventListener("submit", (event) => {
                event.preventDefault();
                const text = input.value.trim();
                if (!text) return;
                socket.emit("chat:message", {
                    text
                });
                input.value = "";
                input.focus();
            });
            window.addEventListener("keydown", (event) => {
                if (document.activeElement === input) {
                    if (event.key === "Enter") {
                        submit.click();
                    }
                }
            });
        }

        // ========== CLICKER ==========
        const zone = document.querySelector(".zone");
        const acpsEl = document.querySelector(".acps");
        const resetBtn = document.querySelector(".reset");
        const medalsWrap = document.querySelector(".medals-wrap");
        const leaderboardBody = document.querySelector("#leaderboard tbody");
        const yourScoreEl = document.getElementById("your-score");

        let scoreActuel = 0;
        let cpsActuel = 0;
        let autoClickTimer = null;
        let medalsDebloquees = new Set();
        let clicksManuels = [];
        let cpsHumain = 0;
        let timerHumain = null;

        const medals = [{
                nom: "Bronze",
                icon: "ü•â",
                pallier: 2500,
                cps: 1
            },
            {
                nom: "Argent",
                icon: "ü•à",
                pallier: 5000,
                cps: 3
            },
            {
                nom: "Or",
                icon: "ü•á",
                pallier: 10000,
                cps: 5
            },
            {
                nom: "Diamant",
                icon: "üíé",
                pallier: 20000,
                cps: 7
            },
            {
                nom: "Rubis",
                icon: "‚ù§Ô∏è‚Äçüî•",
                pallier: 40000,
                cps: 9
            },
            {
                nom: "Saphir",
                icon: "üí†",
                pallier: 80000,
                cps: 11
            },
            {
                nom: "L√©gendaire",
                icon: "üëë",
                pallier: 160000,
                cps: 13
            },
        ];

        function setAutoClick(cps) {
            if (autoClickTimer) clearInterval(autoClickTimer);
            cpsActuel = cps;

            if (acpsEl) acpsEl.textContent = cps > 0 ? `+ ${cps} cps` : "";
            if (cps > 0) {
                const delay = 1000;
                autoClickTimer = setInterval(() => {
                    for (let i = 0; i < cps; i++) {
                        socket.emit("clicker:click");
                    }
                }, delay + 575);
            }
        }

        function stopAutoClicks() {
            if (autoClickTimer) clearInterval(autoClickTimer);
            cpsActuel = 0;
            if (acpsEl) acpsEl.textContent = "";
        }

        function bumpZone() {
            zone?.classList.add("temp");
            setTimeout(() => zone?.classList.remove("temp"), 120);
        }

        function showNotif(text, duration = 4500) {
            const notif = document.createElement("div");
            notif.className = "notif";
            notif.textContent = text;
            notif.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #00ff00;
      opacity: 0.87;
      color: #000;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), duration);
        }

        function verifMedals(score) {
            let medalCible = null;
            for (let i = medals.length - 1; i >= 0; i--) {
                if (score >= medals[i].pallier) {
                    medalCible = medals[i];
                    break;
                }
            }

            if (medalCible) {
                medals.forEach((medal) => {
                    const medalEl = medalsWrap?.querySelector(`.medal[data-name="${medal.nom}"]`);
                    if (!medalEl) return;

                    if (medal.pallier <= medalCible.pallier) {
                        if (!medalEl.classList.contains("shown")) {
                            medalEl.classList.add("shown");
                            medalEl.classList.remove("hidden");
                        }

                        if (!medalsDebloquees.has(medal.nom)) {
                            medalsDebloquees.add(medal.nom);
                            if (medal === medalCible) {
                                showNotif(`>> M√©daille ${medal.nom} d√©bloqu√©e! ${medal.icon}`);
                            }
                        }
                    }
                });

                if (medalCible.cps !== cpsActuel) {
                    setAutoClick(medalCible.cps);
                }
            }
        }

        function resetProgress() {
            const confirmReset = confirm(
                "‚ö†Ô∏è Es-tu s√ªr de vouloir tout r√©initialiser ?\nTon score et tes m√©dailles seront perdus !"
            );
            if (!confirmReset) return;

            socket.emit("clicker:reset");
            stopAutoClicks();
            scoreActuel = 0;
            medalsDebloquees.clear();
            if (yourScoreEl) yourScoreEl.textContent = "0";
            if (acpsEl) acpsEl.textContent = "";
            medalsWrap?.querySelectorAll(".medal").forEach((m) => {
                m.classList.remove("shown");
                m.classList.add("hidden");
            });
            showNotif("üîÅ Progression r√©initialis√©e !");
        }

        if (resetBtn) resetBtn.addEventListener("click", resetProgress);

        function updateDisplay(score) {
            scoreActuel = score;
            bumpZone();
            if (zone) zone.innerHTML = `<i>${score.toLocaleString()}</i>`;
            verifMedals(score);
        }

        socket.on("clicker:you", ({
            score
        }) => {
            updateDisplay(score);
            if (yourScoreEl) yourScoreEl.textContent = score;
        });

        socket.on("leaderboard:update", (items) => {
            if (!leaderboardBody) return;
            leaderboardBody.innerHTML = "";
            items.forEach((row, i) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${i + 1}</td><td>${row.ip}</td><td>${row.score}</td>`;
                if (row.score === scoreActuel) tr.style.background = "#000";
                leaderboardBody.appendChild(tr);
            });
        });

        if (zone) {
            zone.addEventListener("click", () => {
                socket.emit("clicker:click");

                const mtn = Date.now();
                clicksManuels.push(mtn);
                clicksManuels = clicksManuels.filter(tps => mtn - tps < 1000);
                cpsHumain = clicksManuels.length / 1; // cps sur 1 s

                clearTimeout(timerHumain);
                timerHumain = setTimeout(() => {
                  cpsHumain = 0;
                }, 1100);
            });
        }

        setInterval(() => { // affich cps humain
          if (document.querySelector(".cps-humain")) {
            const cpsHumainTxt = cpsHumain >= 0 ? `${cpsHumain.toFixed(1)} CPS` : "";
            document.querySelector(".cps-humain").textContent = `${cpsHumainTxt ? cpsHumainTxt : ""}`;
          }
        }, 225);
    });
});
        </script>
  </head>

  <script>
        //Commun
        document.addEventListener("keydown", (event) => {
            if (event.key === "Space" || event.key === "ArrowUp" || event.key === "Enter") {
                event.preventDefault();
            }
        });
         </script>

  <body>

    <section id="1" class="first-stage">
      <div class="btns-wrap">
        <button class="H">Horloge</button>
        <button class="P">Pauses</button>
        <button class="C">Clicker</button>
        <button class="M">M√©dailles</button>
      </div>

      <center>
        <h1 data-state="shown"></h1>

        <ul data-state="hidden" style="visibility: hidden;">
          <li data-debut-pause="8.9167">8H55</li>
          <li data-debut-pause="9.8333">9H50</li>
          <li data-debut-pause="11.0000">11H00</li>
          <li data-debut-pause="11.9167">11H55</li>
          <li data-debut-pause="15.7500">15H45</li>
          <li data-debut-pause="16.8333">16H50</li>
          <li data-debut-pause="17.9167">17H55</li>
        </ul>
      </center>

      <div class="zone-wrap" data-state="shown">
        <div class="zone"></div>
        <p class="cps-humain"></p>
        <i class="acps"></i>
        <button class="reset">RESET</button>
      </div>

      <div class="medals-wrap" data-state="shown">
        <div data-name="Bronze" class="medal hidden first-reward"></div>
        <div data-name="Argent"
          class="medal hidden second-reward"></div>
        <div data-name="Or" class="medal hidden third-reward"></div>
        <div data-name="Diamant"
          class="medal hidden fourth-reward"></div>
        <div data-name="Rubis" class="medal hidden fifth-reward"></div>
        <div data-name="Saphir" class="medal hidden sixth-reward"></div>
        <div data-name="L√©gendaire"
          class="medal hidden seventh-reward"></div>
      </div>
    </section>

    <section id="2" class="second-stage">
      <div class="dino-wrap">
        <div class="dino-btns-wrap">
          <button class="dino-start">Jouer</button>
          <button class="dino-reset">Reset</button>
        </div>
        <canvas class="game"></canvas>
      </div>
    </section>

    <section id="3" class="third-stage">
      <div class="chat-card" role="region" aria-label="Chat LAN">
        <div class="chat-header">
          <h2>Chat.exe</h2>
          <div class="chat-status">
            <span id="me"></span>
            <span id="usersCount"></span>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages"
          aria-live="polite"></div>
        <form id="chat-form" autocomplete="off" autocorrect="off"
          class="chat-form">
          <input id="chat-input" type="text"
            placeholder="..."
            aria-label="Message" />
          <button type="submit" title="Envoyer"
            class="submit">Envoyer</button>
        </form>
      </div>
    </section>
    <section id="4" class="fourth-stage">
      <div class="leaderboard-card">
        <div class="leaderboard-header"><h2>Leaderboard.exe</h2>
          <div class="you-score">Votre score : <span
              id="your-score">0</span></div></div>
        <table class="board" id="leaderboard">
          <thead><tr><th>Rang</th><th>IP</th><th>Score</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </body>

</html>
